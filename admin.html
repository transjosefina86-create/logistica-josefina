<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Control - La Josefina</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .seccion { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #ff6600; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* GESTI√ìN SUPERIOR */
        .grid-gestion { display: grid; grid-template-columns: repeat(3, 1fr) auto; gap: 10px; margin-bottom: 20px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .btn-crear { background: #ff6600; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* TABLAS */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #333; color: white; font-size: 13px; }
        
        .btn-ojo { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-pdf-ver { background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* ESTADOS CRUCIALES */
        .badge { padding: 6px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-reclamo { background: #ffc107; color: #000; } /* Amarillo: Pediste foto */
        .status-reenviado { background: #28a745; color: #fff; } /* Verde: El chofer cumpli√≥ */
        .alerta-cambio { background: #dc3545; color: white; padding: 2px 5px; border-radius: 4px; font-size: 10px; margin-left: 5px; }

        /* MODALES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 800px; border-radius: 15px; position: relative; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f9f9f9; padding: 20px; border-radius: 10px; }
        .info-item b { color: #ff6600; font-size: 11px; display: block; }
        
        #visor-pdf { text-align: center; margin-top: 20px; background: #444; padding: 20px; border-radius: 10px; }
        #visor-pdf img { max-width: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="seccion">
        <h2>GESTI√ìN DE CHOFERES</h2>
        <div class="grid-gestion">
            <input type="text" id="u-nom" placeholder="Usuario">
            <input type="text" id="u-pin" placeholder="PIN">
            <input type="text" id="u-tel" placeholder="WhatsApp">
            <button class="btn-crear" onclick="crearAcceso()">+ AGREGAR</button>
        </div>
        <table id="tabla-choferes">
            <thead><tr><th>Usuario</th><th>PIN</th><th>WhatsApp</th><th>Acci√≥n</th></tr></thead>
            <tbody id="body-choferes"></tbody>
        </table>
    </div>

    <div class="seccion">
        <h2>LISTADO DE REPORTES</h2>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Chofer</th>
                    <th>Transporte</th>
                    <th>Control</th>
                    <th>Estado</th>
                    <th>Ticket</th>
                </tr>
            </thead>
            <tbody id="body-reportes"></tbody>
        </table>
    </div>

    <div id="modalOjo" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span style="float:right; cursor:pointer;" onclick="cerrarModales()">‚úñ</span>
            <h3>CONTROL DE DATOS CARGADOS</h3>
            <div id="detalle-ojo" class="info-grid"></div>
        </div>
    </div>

    <div id="modalPDF" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer;" onclick="cerrarModales()">‚úñ</span>
            <h3>VISOR DE TICKET / PDF</h3>
            <div id="visor-pdf"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-crear" style="flex:1; background:#007bff;" onclick="descargarPDF()">üì• DESCARGAR PDF</button>
                <button class="btn-crear" style="flex:1; background:#dc3545;" onclick="reclamarFoto()">‚ö†Ô∏è RECLAMAR FOTO (WHATSAPP)</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let actual = null, idAct = "";

        // GESTION CHOFERES
        async function crearAcceso() {
            const u = document.getElementById('u-nom').value.toLowerCase();
            const p = document.getElementById('u-pin').value;
            const t = document.getElementById('u-tel').value;
            if(u && p && t) await db.collection("accesos_choferes").doc(u).set({ clave: p, telefono: t });
        }

        db.collection("accesos_choferes").onSnapshot(snap => {
            const b = document.getElementById('body-choferes'); b.innerHTML = "";
            snap.forEach(doc => {
                b.innerHTML += `<tr><td>${doc.id}</td><td>${doc.data().clave}</td><td>${doc.data().telefono}</td><td><button onclick="borrarAcceso('${doc.id}')">Eliminar</button></td></tr>`;
            });
        });

        async function borrarAcceso(id) { if(confirm("¬øEliminar?")) await db.collection("accesos_choferes").doc(id).delete(); }

        // REPORTES Y L√ìGICA DE ESTADOS
        db.collection("reportes").orderBy("fecha", "desc").onSnapshot(snap => {
            const b = document.getElementById('body-reportes'); b.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                let clase = "";
                let texto = d.estado;

                if(d.estado === "PIDIENDO REENV√çO") {
                    clase = "status-reclamo";
                    texto = "FOTO RECLAMADA";
                } else if(d.reenviada) {
                    clase = "status-reenviado";
                    texto = "FOTO REENVIADA";
                }

                b.innerHTML += `
                    <tr>
                        <td>${d.fecha}</td>
                        <td>${d.chofer_nombre}</td>
                        <td>${d.transporte}</td>
                        <td><button class="btn-ojo" onclick="verOjo('${doc.id}')">üëÅÔ∏è DATOS</button></td>
                        <td><span class="badge ${clase}">${texto}</span></td>
                        <td><button class="btn-pdf-ver" onclick="verPDF('${doc.id}')">üìÑ PDF</button></td>
                    </tr>`;
            });
        });

        async function verOjo(id) {
            const doc = await db.collection("reportes").doc(id).get();
            const d = doc.data();
            // Aqu√≠ podr√≠as comparar con un "perfil maestro" si lo tuvieras, 
            // por ahora mostramos todo lo que el chofer carg√≥ en este reporte.
            document.getElementById('detalle-ojo').innerHTML = `
                <div class="info-item"><b>TRANSPORTE:</b> ${d.transporte}</div>
                <div class="info-item"><b>CUIT:</b> ${d.cuit_trans}</div>
                <div class="info-item"><b>CHOFER:</b> ${d.chofer_nombre}</div>
                <div class="info-item"><b>CUIL:</b> ${d.chofer_cuil}</div>
                <div class="info-item"><b>CHASIS:</b> ${d.chasis}</div>
                <div class="info-item"><b>ACOPLADO:</b> ${d.acoplado}</div>
                <div class="info-item"><b>EQUIPO:</b> ${d.equipo}</div>`;
            document.getElementById('modalOjo').style.display = "block";
        }

        async function verPDF(id) {
            idAct = id; const doc = await db.collection("reportes").doc(id).get(); actual = doc.data();
            const visor = document.getElementById('visor-pdf');
            visor.innerHTML = actual.fotos && actual.fotos.length > 0 ? 
                `<img src="${actual.fotos[0]}" id="img-ticket">` : 
                `<p style="color:white">‚ö†Ô∏è FOTO ELIMINADA - ESPERANDO REENV√çO</p>`;
            document.getElementById('modalPDF').style.display = "block";
        }

        async function reclamarFoto() {
            if(!confirm("¬øReclamar nueva foto? Se borrar√° la actual.")) return;
            const cDoc = await db.collection("accesos_choferes").doc(actual.chofer).get();
            const tel = cDoc.exists ? cDoc.data().telefono : "";
            
            // Borramos foto y cambiamos estado
            await db.collection("reportes").doc(idAct).update({ 
                fotos: [], 
                estado: "PIDIENDO REENV√çO", 
                reenviada: false 
            });

            window.open(`https://api.whatsapp.com/send?phone=${tel}&text=Hola ${actual.chofer_nombre}, la foto de ${actual.transporte} no es legible. Por favor envi√° una nueva desde la App.`, '_blank');
            cerrarModales();
        }

        function descargarPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const img = document.getElementById('img-ticket');
            doc.text(`TICKET: ${actual.transporte}`, 10, 10);
            if(img) doc.addImage(img.src, 'JPEG', 10, 20, 180, 160);
            doc.save(`Ticket_${actual.chofer_nombre}.pdf`);
        }

        function cerrarModales() { 
            document.getElementById('modalOjo').style.display = "none"; 
            document.getElementById('modalPDF').style.display = "none"; 
        }
    </script>
</body>
</html>
























































