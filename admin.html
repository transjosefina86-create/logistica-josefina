<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Administrativo - La Josefina</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: none; }
        .header { background: #333; color: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* TABLA Y COLORES */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #444; color: white; font-size: 12px; }
        .fila-vacio { background-color: #d4edda !important; }
        .fila-cargado { background-color: #f8d7da !important; }

        /* MODALES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: white; margin: 1% auto; padding: 20px; width: 95%; max-width: 850px; border-radius: 15px; position: relative; max-height: 90vh; overflow-y: auto; }
        
        /* FICHA DEL OJITO */
        .ficha-datos { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #ddd; }
        .dato-item { border-bottom: 1px solid #eee; padding: 8px 0; }
        .dato-item b { color: #ff6600; display: block; font-size: 11px; text-transform: uppercase; }
        .dato-item span { font-size: 16px; font-weight: bold; color: #333; }

        /* VISOR SCANNER */
        .controles-scanner { background: #f1f1f1; padding: 15px; border-radius: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .control-item { display: flex; flex-direction: column; font-size: 11px; font-weight: bold; }
        #visor-foto { background: #444; padding: 10px; border-radius: 8px; text-align: center; }
        #img-ticket { max-width: 100%; max-height: 500px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }

        .btn-accion { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
    </style>
</head>
<body id="cuerpo">

    <div class="header">
        <h2>LA JOSEFINA - PANEL CONTROL</h2>
        <button class="btn-accion" style="background:#ff6600;" onclick="toggleGestion()">‚öôÔ∏è GESTIONAR CHOFERES</button>
    </div>

    <div id="box-gestion" style="display:none; background:white; padding:20px; border-radius:12px; margin-bottom:20px;">
        <div style="display:grid; grid-template-columns: repeat(3, 1fr) auto; gap:10px;">
            <input type="text" id="u-nom" placeholder="Usuario">
            <input type="text" id="u-pin" placeholder="PIN">
            <input type="text" id="u-tel" placeholder="WhatsApp">
            <button class="btn-accion" style="background:#333;" onclick="guardarChofer()">GUARDAR</button>
        </div>
        <table style="margin-top:10px;"><tbody id="lista-choferes"></tbody></table>
    </div>

    <table>
        <thead>
            <tr>
                <th>FECHA / HORA</th>
                <th>ESTADO</th>
                <th>CHOFER</th>
                <th>TRANSPORTE</th>
                <th>DATOS</th>
                <th>TICKET</th>
            </tr>
        </thead>
        <tbody id="lista-reportes"></tbody>
    </table>

    <div id="modalDatos" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span style="float:right; cursor:pointer; font-size:24px;" onclick="cerrarModales()">‚úñ</span>
            <h2 style="margin-top:0; color:#333;">DATOS CARGADOS POR CHOFER</h2>
            <div id="ficha-chofer" class="ficha-datos"></div>
        </div>
    </div>

    <div id="modalPDF" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer; font-size:24px;" onclick="cerrarModales()">‚úñ</span>
            <h3 style="margin-top:0;">EDICI√ìN Y NITIDEZ DEL TICKET</h3>
            
            <div class="controles-scanner">
                <div class="control-item">BRILLO <input type="range" id="brillo" min="50" max="250" value="100" oninput="aplicarScanner()"></div>
                <div class="control-item">CONTRASTE <input type="range" id="contraste" min="50" max="250" value="120" oninput="aplicarScanner()"></div>
                <div class="control-item">EXPOSICI√ìN <input type="range" id="expo" min="50" max="200" value="100" oninput="aplicarScanner()"></div>
                <div class="control-item">NITIDEZ <input type="range" id="nitidez" min="0" max="200" value="100" oninput="aplicarScanner()"></div>
            </div>

            <div id="visor-foto"><img id="img-ticket" src=""></div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-accion" style="background:#28a745; flex:1; font-size:16px;" onclick="descargarPDF()">üì• DESCARGAR PDF (A4)</button>
                <button class="btn-accion" style="background:#dc3545; flex:1; font-size:16px;" onclick="pedirReenvio()">‚ö†Ô∏è RECLAMAR POR WHATSAPP</button>
            </div>
        </div>
    </div>

    <script>
        const pinAcceso = prompt("PIN Administrador:");
        if(pinAcceso === "1234") { document.getElementById('cuerpo').style.display = 'block'; }
        else { alert("PIN Incorrecto"); window.location.reload(); }

        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let actual = null, idAct = "";

        function toggleGestion() { const b = document.getElementById('box-gestion'); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }
        
        async function guardarChofer() {
            const u = document.getElementById('u-nom').value.toLowerCase();
            const p = document.getElementById('u-pin').value;
            const t = document.getElementById('u-tel').value;
            if(u && p && t) await db.collection("accesos_choferes").doc(u).set({ clave: p, telefono: t });
        }

        db.collection("reportes").onSnapshot(snap => {
            const l = document.getElementById('lista-reportes'); l.innerHTML = "";
            let reportes = [];
            snap.forEach(doc => { reportes.push({id: doc.id, ...doc.data()}); });

            reportes.sort((a, b) => {
                const estA = (a.estado === 'VAC√çO') ? 0 : 1;
                const estB = (b.estado === 'VAC√çO') ? 0 : 1;
                if (estA !== estB) return estA - estB;
                return new Date(a.fecha) - new Date(b.fecha);
            });

            reportes.forEach(d => {
                let claseFila = d.estado === 'VAC√çO' ? 'fila-vacio' : 'fila-cargado';
                let btnPdf = (d.fotos && d.fotos.length > 0) ? `<button class="btn-accion" style="background:#28a745; padding:5px 10px;" onclick="verP('${d.id}')">üìÑ PDF</button>` : "-";
                let aviso = d.estado === "PIDIENDO REENV√çO" ? `<span style="background:orange; color:black; font-size:9px; padding:2px; border-radius:4px; margin-left:5px;">RECLAMADA</span>` : "";
                if(d.reenviada) aviso = `<span style="background:green; color:white; font-size:9px; padding:2px; border-radius:4px; margin-left:5px;">NUEVA</span>`;

                l.innerHTML += `
                    <tr class="${claseFila}">
                        <td>${d.fecha}</td>
                        <td>
                            <select onchange="cambiarEstado('${d.id}', this.value)" style="font-weight:bold;">
                                <option value="VAC√çO" ${d.estado === 'VAC√çO' ? 'selected' : ''}>VAC√çO</option>
                                <option value="CARGADO" ${d.estado === 'CARGADO' || d.estado === 'FOTO REENVIADA' ? 'selected' : ''}>CARGADO</option>
                            </select>
                            ${aviso}
                        </td>
                        <td><b>${d.chofer_nombre}</b></td>
                        <td>${d.transporte}</td>
                        <td><button class="btn-accion" style="background:#007bff; padding:5px 10px;" onclick="verD('${d.id}')">üëÅÔ∏è</button></td>
                        <td>${btnPdf}</td>
                    </tr>`;
            });
        });

        async function cambiarEstado(id, n) { await db.collection("reportes").doc(id).update({ estado: n }); }

        async function verD(id) {
            const doc = await db.collection("reportes").doc(id).get(); const d = doc.data();
            document.getElementById('ficha-chofer').innerHTML = `
                <div class="dato-item"><b>Transporte</b><span>${d.transporte}</span></div>
                <div class="dato-item"><b>CUIT Empresa</b><span>${d.cuit_trans}</span></div>
                <div class="dato-item"><b>Chofer</b><span>${d.chofer_nombre}</span></div>
                <div class="dato-item"><b>CUIL Chofer</b><span>${d.chofer_cuil}</span></div>
                <div class="dato-item"><b>Patente Chasis</b><span>${d.chasis}</span></div>
                <div class="dato-item"><b>Patente Acoplado</b><span>${d.acoplado}</span></div>
                <div class="dato-item"><b>Tipo de Equipo</b><span>${d.equipo}</span></div>
                <div class="dato-item"><b>Estado Reportado</b><span>${d.estado}</span></div>`;
            document.getElementById('modalDatos').style.display = 'block';
        }

        async function verP(id) {
            idAct = id; const doc = await db.collection("reportes").doc(id).get(); actual = doc.data();
            document.getElementById('img-ticket').src = actual.fotos[0];
            document.getElementById('modalPDF').style.display = 'block';
            resetScanner();
        }

        function aplicarScanner() {
            const b = document.getElementById('brillo').value;
            const c = document.getElementById('contraste').value;
            const e = document.getElementById('expo').value;
            const n = document.getElementById('nitidez').value;
            document.getElementById('img-ticket').style.filter = `brightness(${b}%) contrast(${c}%) brightness(${e}%) saturate(${n}%) grayscale(20%)`;
        }

        function resetScanner() { 
            document.getElementById('brillo').value = 100; document.getElementById('contraste').value = 140; 
            document.getElementById('expo').value = 100; document.getElementById('nitidez').value = 100; aplicarScanner(); 
        }

        async function pedirReenvio() {
            const cDoc = await db.collection("accesos_choferes").doc(actual.chofer).get();
            await db.collection("reportes").doc(idAct).update({ fotos: [], estado: "PIDIENDO REENV√çO", reenviada: false });
            window.open(`https://api.whatsapp.com/send?phone=${cDoc.data().telefono}&text=Hola ${actual.chofer_nombre}, reenv√≠a la foto de ${actual.transporte} por favor.`, '_blank');
            cerrarModales();
        }

        function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const img = document.getElementById('img-ticket');
            const canvas = document.createElement('canvas');
            const imgObj = new Image();
            imgObj.src = img.src;

            imgObj.onload = () => {
                canvas.width = imgObj.width; canvas.height = imgObj.height;
                const ctx = canvas.getContext('2d');
                ctx.filter = img.style.filter;
                ctx.drawImage(imgObj, 0, 0);
                
                // Encabezado en el PDF
                doc.setFontSize(10);
                doc.text(`Transporte: ${actual.transporte} | Chofer: ${actual.chofer_nombre} | Fecha: ${actual.fecha}`, 10, 10);
                
                // Imagen tama√±o A4 (210mm x 297mm)
                // Dejamos margen de 15mm arriba para el texto
                doc.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 5, 15, 200, 270);
                doc.save(`Ticket_${actual.chofer_nombre}.pdf`);
            };
        }

        function cerrarModales() { 
            document.getElementById('modalPDF').style.display = 'none'; 
            document.getElementById('modalDatos').style.display = 'none'; 
        }
    </script>
</body>
</html>




























































