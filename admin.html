<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Josefina - Admin</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --naranja: #ff6600; --oscuro: #222; --verde: #27ae60; --azul: #2980b9; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        
        /* LOGIN */
        #bloqueo { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--oscuro); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .card-login { background:white; padding:40px; border-radius:25px; text-align:center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }

        /* TABLA Y PANEL */
        .main-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 1400px; margin: auto; display:none; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--naranja); padding-bottom: 15px; margin-bottom: 20px; }
        .logo { font-family: 'Brush Script MT', cursive; font-size: 38px; color: var(--naranja); }

        table { width: 100%; border-collapse: collapse; }
        th { background: var(--oscuro); color: white; padding: 15px; text-align: left; font-size: 13px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        .btn { border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-ojo { background: var(--azul); }
        .btn-pdf { background: #e74c3c; }
        .btn-negro { background: var(--oscuro); }
        
        /* ESTADOS INTERACTIVOS */
        .badge { padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; color: white; cursor: pointer; border: none; text-transform: uppercase; width: 110px; text-align: center; }
        .bg-vacio { background: var(--verde); box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); }
        .bg-cargado { background: var(--naranja); box-shadow: 0 4px 10px rgba(255, 102, 0, 0.2); }

        /* MODAL DETALLES (OJITO CORREGIDO) */
        .modal-detalles { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:11000; }
        .detalles-box { background:white; padding:30px; border-radius:20px; width:90%; max-width:550px; text-align:left; }
        .linea-dato { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 15px; }

        /* MODAL SCANNER */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10000; }
        .modal-box { background:white; padding:20px; border-radius:25px; width:95%; max-width:1100px; text-align:center; }
        #canvas-pdf { width: 100%; max-height: 60vh; object-fit: contain; border: 2px solid #333; border-radius: 12px; background: #fff; margin-bottom: 10px; }
        .controles-scanner { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        input[type=range] { width: 100%; accent-color: var(--naranja); }

        .footer-modal { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="bloqueo">
        <div class="card-login">
            <div class="logo">La Josefina</div>
            <input type="password" id="pass-adm" placeholder="Clave Administrador" style="padding:15px; width:220px; border-radius:12px; border:2px solid #ddd; font-size: 18px; text-align:center;"><br><br>
            <button class="btn btn-negro" style="width:100%; height:50px;" onclick="entrar()">ENTRAR AL SISTEMA</button>
        </div>
    </div>

    <div id="modal-info" class="modal-detalles">
        <div class="detalles-box">
            <h3 style="color:var(--naranja); margin-top:0;">Informaci√≥n del Viaje</h3>
            <div id="contenido-info" style="user-select: all;"></div>
            <br>
            <button class="btn btn-negro" style="width:100%" onclick="cerrarInfo()">CERRAR</button>
        </div>
    </div>

    <div class="main-card" id="app">
        <div class="header">
            <div class="logo">La Josefina</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-negro" onclick="verClaves()">GESTIONAR CHOFERES</button>
                <button class="btn btn-negro" onclick="nuevaClave()">+ NUEVO</button>
                <button class="btn btn-pdf" style="background:#444;" onclick="borrarSels()">ELIMINAR SELECCI√ìN</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="seleccionarTodo(this)"></th>
                    <th>FECHA Y HORA</th>
                    <th>ESTADO</th>
                    <th>CHOFER</th>
                    <th>TRANSPORTE</th>
                    <th>PATENTE</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tabla-body"></tbody>
        </table>
    </div>

    <div id="modal-pdf" class="modal">
        <div class="modal-box">
            <h3 id="tit-chof" style="margin:0 0 10px 0; color:var(--naranja)">Filtro CamScanner</h3>
            <canvas id="canvas-pdf"></canvas>
            <div class="controles-scanner">
                <div>
                    <label style="font-size:11px; font-weight:bold;">LIMPIEZA DE HOJA</label>
                    <input type="range" id="limpieza" min="100" max="250" value="120" oninput="procesarFiltro()">
                </div>
                <div>
                    <label style="font-size:11px; font-weight:bold;">NITIDEZ LETRA</label>
                    <input type="range" id="contraste" min="100" max="400" value="150" oninput="procesarFiltro()">
                </div>
                <div>
                    <label style="font-size:11px; font-weight:bold;">CONTRASTE NEGRO</label>
                    <input type="range" id="negro" min="0" max="100" value="10" oninput="procesarFiltro()">
                </div>
            </div>
            <div class="footer-modal">
                <button class="btn" style="background:#666; flex:1" onclick="cerrarModal()">CANCELAR</button>
                <button class="btn" style="background:#f39c12; flex:1" onclick="pedirFoto()">PEDIR OTRA FOTO</button>
                <button class="btn btn-pdf" style="flex:2; font-size:18px;" id="btn-descargar">GENERAR PDF LIMPIO</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let imgObj = new Image();
        let reporteActual = null;

        function entrar() { if(document.getElementById('pass-adm').value === "1234") { document.getElementById('bloqueo').style.display='none'; document.getElementById('app').style.display='block'; cargarReportes(); } }

        function cargarReportes() {
            db.collection("reportes").onSnapshot(snap => {
                const t = document.getElementById('tabla-body'); t.innerHTML = "";
                let lista = []; snap.forEach(doc => { let d = doc.data(); d.id = doc.id; lista.push(d); });
                
                // ORDEN: Vac√≠os arriba, luego por hora [cite: 9, 13]
                lista.sort((a,b) => {
                    if(a.estado === "VAC√çO" && b.estado !== "VAC√çO") return -1;
                    if(a.estado !== "VAC√çO" && b.estado === "VAC√çO") return 1;
                    return new Date(b.fecha.replace(',','')) - new Date(a.fecha.replace(',',''));
                });

                lista.forEach(r => {
                    const tieneFotos = (r.fotos && r.fotos.length > 0);
                    const claseEstado = r.estado === 'VAC√çO' ? 'bg-vacio' : 'bg-cargado';
                    t.innerHTML += `<tr>
                        <td><input type="checkbox" class="chk" data-id="${r.id}"></td>
                        <td><b>${r.fecha}</b></td>
                        <td><button class="badge ${claseEstado}" onclick="cambiarEstadoManual('${r.id}', '${r.estado}')">${r.estado}</button></td>
                        <td><b>${r.chofer}</b></td>
                        <td>${r.transporte || '---'}</td>
                        <td>${r.chasis || '---'}</td>
                        <td>
                            <button class="btn btn-ojo" onclick="verDetalles('${r.id}')">üëÅÔ∏è</button>
                            ${tieneFotos ? `<button class="btn btn-pdf" onclick="abrirEditor('${r.id}')">PDF</button>` : ''}
                        </td>
                    </tr>`;
                });
            });
        }

        async function cambiarEstadoManual(id, estadoActual) {
            const nuevoEstado = estadoActual === 'VAC√çO' ? 'CARGADO' : 'VAC√çO';
            await db.collection("reportes").doc(id).update({ estado: nuevoEstado });
        }

        function verDetalles(id) {
            db.collection("reportes").doc(id).get().then(doc => {
                const d = doc.data();
                // Renglones juntos para copiar f√°cil 
                document.getElementById('contenido-info').innerHTML = `
                    <div class="linea-dato"><b>TRANSPORTE:</b> ${d.transporte}</div>
                    <div class="linea-dato"><b>CUIT TRANS:</b> ${d.cuit_trans}</div>
                    <div class="linea-dato"><b>CHOFER:</b> ${d.chofer}</div>
                    <div class="linea-dato"><b>CUIT CHOFER:</b> ${d.cuit_chofer || '---'}</div>
                    <div class="linea-dato"><b>PATENTE CHASIS:</b> ${d.chasis}</div>
                    <div class="linea-dato"><b>PATENTE ACOPLADO:</b> ${d.acoplado}</div>
                    <div class="linea-dato"><b>FECHA LLEGADA:</b> ${d.fecha}</div>
                `;
                document.getElementById('modal-info').style.display = 'flex';
            });
        }
        function cerrarInfo() { document.getElementById('modal-info').style.display = 'none'; }

        async function abrirEditor(id) {
            const doc = await db.collection("reportes").doc(id).get();
            reporteActual = {id, ...doc.data()};
            imgObj.src = reporteActual.fotos[0]; 
            imgObj.onload = () => { 
                document.getElementById('modal-pdf').style.display='flex'; 
                procesarFiltro(); 
            }
        }

        function procesarFiltro() {
            const canvas = document.getElementById('canvas-pdf');
            const ctx = canvas.getContext('2d');
            canvas.width = imgObj.width; canvas.height = imgObj.height;
            
            const l = document.getElementById('limpieza').value;
            const c = document.getElementById('contraste').value;
            const n = document.getElementById('negro').value;

            ctx.clearRect(0,0,canvas.width,canvas.height);
            // Filtro estilo CamScanner: Blanco puro y negro resaltado 
            ctx.filter = `grayscale(1) brightness(${l}%) contrast(${c}%) saturate(0)`;
            ctx.drawImage(imgObj, 0, 0);

            // Capa de refuerzo para el negro de las letras
            if(n > 0) {
                ctx.globalAlpha = n / 100;
                ctx.globalCompositeOperation = "multiply";
                ctx.drawImage(canvas, 0, 0);
                ctx.globalCompositeOperation = "source-over";
                ctx.globalAlpha = 1;
            }

            document.getElementById('btn-descargar').onclick = () => {
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                pdf.addImage(imgData, 'JPEG', 5, 10, 200, 280); 
                pdf.save(`TICKET_${reporteActual.chofer}.pdf`);
            };
        }

        function pedirFoto() { 
            if(confirm("¬øPedir al chofer que env√≠e la foto de nuevo? Los datos del horario se mantendr√°n.")) {
                db.collection("reportes").doc(reporteActual.id).update({ fotos: [] });
                cerrarModal();
            }
        }
        function cerrarModal() { document.getElementById('modal-pdf').style.display='none'; }
        function verClaves() { db.collection("accesos_choferes").get().then(s => { let l=""; s.forEach(d => l += `${d.id}: ${d.data().clave}\n`); alert(l); }); }
        function nuevaClave() { const n = prompt("Nombre:"); const c = prompt("Clave:"); if(n && c) db.collection("accesos_choferes").doc(n).set({clave: c}); }
        function seleccionarTodo(s) { document.querySelectorAll('.chk').forEach(x => x.checked = s.checked); }
        function borrarSels() { if(confirm("¬øBorrar seleccionados?")) { document.querySelectorAll('.chk:checked').forEach(x => db.collection("reportes").doc(x.dataset.id).delete()); } }
    </script>
</body>
</html>













































