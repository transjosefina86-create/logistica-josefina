<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - La Josefina</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --naranja: #ff6600; --oscuro: #222; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        
        #bloqueo { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--oscuro); z-index:5000; display:flex; justify-content:center; align-items:center; }
        .card-login { background:white; padding:35px; border-radius:20px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .main-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 1300px; margin: auto; display:none; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--naranja); padding-bottom: 15px; margin-bottom: 15px; }
        .logo { font-family: 'Brush Script MT', cursive; font-size: 32px; color: var(--naranja); }

        table { width: 100%; border-collapse: collapse; }
        th { background: var(--naranja); color: white; padding: 10px; text-align: left; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        
        .btn { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; margin: 2px; }
        .btn-ojo { background: #3498db; }
        .btn-pdf { background: #e74c3c; }
        .btn-negro { background: var(--oscuro); }
        .alerta-patente { background: #ffeded; color: #c0392b; font-weight: bold; padding: 2px 5px; border-radius: 4px; border: 1px solid #ebccd1; }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:6000; }
        .modal-box { background:white; padding:20px; border-radius:20px; width:95%; max-width:700px; text-align:center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        canvas { max-width: 100%; height: auto; max-height: 400px; border: 1px solid #ccc; background: #000; margin-bottom: 10px; }
        
        .sliders { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .sliders label { font-size: 11px; font-weight: bold; color: #666; }
    </style>
</head>
<body>

    <div id="bloqueo">
        <div class="card-login">
            <h2 style="color:var(--naranja)">Control de Cargas</h2>
            <input type="password" id="pass-adm" placeholder="Clave Administrador" style="padding:15px; width:200px; border-radius:10px; border:1px solid #ccc; font-size: 16px;"><br><br>
            <button class="btn btn-negro" style="width:100%; padding:15px;" onclick="entrar()">ACCEDER PANEL</button>
        </div>
    </div>

    <div class="main-card" id="app">
        <div class="header">
            <div class="logo">La Josefina <small style="font-size:12px; color:#666; font-family: sans-serif;">(Panel Administrativo)</small></div>
            <div>
                <button class="btn btn-negro" onclick="verClaves()">GESTIONAR CHOFERES</button>
                <button class="btn btn-negro" onclick="nuevaClave()">+ NUEVO CHOFER</button>
                <button class="btn btn-pdf" style="background:#c0392b" onclick="borrarSels()">ELIMINAR SELECCI√ìN</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="seleccionarTodo(this)"></th>
                    <th>LLEGADA</th>
                    <th>RECIBIDO</th>
                    <th>ESTADO</th>
                    <th>CHOFER</th>
                    <th>PATENTE</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tabla-body"></tbody>
        </table>
    </div>

    <div id="modal-pdf" class="modal">
        <div class="modal-box">
            <h3 id="nom-chof-pdf" style="margin:0 0 10px 0; color:var(--naranja)">Ajuste de Ticket</h3>
            <canvas id="canvas-pdf"></canvas>
            <div class="sliders">
                <div>
                    <label>BRILLO</label><br>
                    <input type="range" id="brillo" min="50" max="250" value="110" style="width:100%" oninput="procesarFiltro()">
                </div>
                <div>
                    <label>NITIDEZ (CONTR.)</label><br>
                    <input type="range" id="contraste" min="100" max="450" value="180" style="width:100%" oninput="procesarFiltro()">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-pdf" style="background:#c0392b; flex:1" onclick="rechazarFoto()">‚úñ RECHAZAR FOTO</button>
                <button class="btn btn-negro" style="flex:1" onclick="cerrarModal()">CANCELAR</button>
                <button class="btn btn-pdf" style="flex:2; padding:15px;" id="btn-descargar">‚úî DESCARGAR PDF</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let imgObj = new Image();
        let reporteActual = null;
        let historicoPatentes = {};

        function entrar() { if(document.getElementById('pass-adm').value === "1234") { document.getElementById('bloqueo').style.display='none'; document.getElementById('app').style.display='block'; cargarReportes(); } else { alert("Clave Incorrecta"); } }

        function cargarReportes() {
            db.collection("reportes").onSnapshot(snap => {
                const t = document.getElementById('tabla-body'); t.innerHTML = "";
                let lista = []; snap.forEach(doc => lista.push({id: doc.id, ...doc.data()}));
                
                // ORDEN: Vac√≠o arriba, Cargado abajo. Siempre por hora de llegada.
                lista.sort((a,b) => {
                    if(a.estado === "VAC√çO" && b.estado === "CARGADO") return -1;
                    if(a.estado === "CARGADO" && b.estado === "VAC√çO") return 1;
                    return new Date(a.fecha.replace(',','')) - new Date(b.fecha.replace(',',''));
                });

                lista.forEach(r => {
                    // Control de cambio de patente
                    let alerta = "";
                    if(historicoPatentes[r.chofer] && historicoPatentes[r.chofer] !== r.chasis) {
                        alerta = " <span class='alerta-patente'>‚ö†Ô∏è CAMBIO</span>";
                    }
                    historicoPatentes[r.chofer] = r.chasis;

                    // Hora de servidor para control de internet
                    if(!r.hora_servidor) {
                        const h = new Date();
                        const horaAct = h.getHours().toString().padStart(2,'0') + ":" + h.getMinutes().toString().padStart(2,'0');
                        db.collection("reportes").doc(r.id).update({hora_servidor: horaAct});
                    }

                    t.innerHTML += `<tr>
                        <td><input type="checkbox" class="chk" data-id="${r.id}"></td>
                        <td style="font-weight:bold;">${r.fecha.split(',')[1]} hs</td>
                        <td style="color:#666">${r.hora_servidor || '--:--'} hs</td>
                        <td style="color:${r.estado==='VAC√çO'?'#27ae60':'#e67e22'}; font-weight:bold;">${r.estado}</td>
                        <td><b>${r.chofer}</b></td>
                        <td>${r.chasis}${alerta}</td>
                        <td>
                            <button class="btn btn-ojo" onclick="verDetalles('${r.id}')">üëÅÔ∏è</button>
                            ${r.fotos && r.fotos.length > 0 ? `<button class="btn btn-pdf" onclick="abrirEditor('${r.id}')">PDF (${r.fotos.length})</button>` : ''}
                        </td>
                    </tr>`;
                });
            });
        }

        function verDetalles(id) {
            db.collection("reportes").doc(id).get().then(doc => {
                const d = doc.data();
                alert(`DATOS COMPLETOS DEL VIAJE\n\n` +
                      `Transporte: ${d.transporte || '---'}\n` +
                      `CUIT Trans: ${d.cuit_trans || '---'}\n` +
                      `Chofer: ${d.chofer}\n` +
                      `CUIT Chof: ${d.cuit_chofer || '---'}\n` +
                      `Patente Chasis: ${d.chasis}\n` +
                      `Patente Acoplado: ${d.acoplado}\n\n` +
                      `Llegada (Celular): ${d.fecha}\n` +
                      `Recibido (Internet): ${d.hora_servidor || '---'} hs`);
            });
        }

        async function abrirEditor(id) {
            const doc = await db.collection("reportes").doc(id).get();
            reporteActual = {id, ...doc.data()};
            document.getElementById('nom-chof-pdf').innerText = "Ticket: " + reporteActual.chofer;
            imgObj.src = reporteActual.fotos[0]; 
            imgObj.onload = () => {
                document.getElementById('modal-pdf').style.display='flex';
                procesarFiltro();
            }
        }

        function procesarFiltro() {
            const canvas = document.getElementById('canvas-pdf');
            const ctx = canvas.getContext('2d');
            canvas.width = imgObj.width; canvas.height = imgObj.height;
            const b = document.getElementById('brillo').value;
            const c = document.getElementById('contraste').value;
            ctx.filter = `grayscale(1) brightness(${b}%) contrast(${c}%)`;
            ctx.drawImage(imgObj, 0, 0);

            document.getElementById('btn-descargar').onclick = () => {
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                reporteActual.fotos.forEach((f, i) => {
                    if(i > 0) pdf.addPage();
                    pdf.setFillColor(255,102,0); pdf.rect(0,0,210,15,'F');
                    pdf.setTextColor(255); pdf.setFontSize(14); pdf.text("LA JOSEFINA - TICKET DE CARGA", 10, 10);
                    pdf.setTextColor(0); pdf.setFontSize(10);
                    pdf.text(`Chofer: ${reporteActual.chofer} | Fecha: ${reporteActual.fecha}`, 10, 22);
                    pdf.addImage(f, 'JPEG', 10, 30, 190, 245);
                });
                pdf.save(`Ticket_${reporteActual.chofer}_${reporteActual.fecha.replace(/[/, :]/g,'_')}.pdf`);
            };
        }

        function rechazarFoto() { if(confirm("¬øEliminar este ticket y pedir uno nuevo?")) { db.collection("reportes").doc(reporteActual.id).delete(); cerrarModal(); } }
        function cerrarModal() { document.getElementById('modal-pdf').style.display='none'; }
        
        function verClaves() { 
            db.collection("accesos_choferes").get().then(s => { 
                let lista = "LISTADO DE CHOFERES:\n\n"; 
                s.forEach(d => lista += `‚Ä¢ ${d.id}: ${d.data().clave}\n`); 
                const borrar = prompt(lista + "\nEscriba el NOMBRE para borrar un chofer (o deje vac√≠o):");
                if(borrar) { if(confirm(`¬øBorrar a ${borrar}?`)) db.collection("accesos_choferes").doc(borrar.toUpperCase()).delete(); }
            }); 
        }

        function nuevaClave() { 
            const n = prompt("Nombre del Chofer:"); 
            const c = prompt("Clave de acceso:"); 
            if(n && c) db.collection("accesos_choferes").doc(n.toUpperCase()).set({clave: c}); 
        }

        function seleccionarTodo(s) { document.querySelectorAll('.chk').forEach(x => x.checked = s.checked); }
        function borrarSels() { 
            if(confirm("¬øBorrar registros seleccionados?")) {
                document.querySelectorAll('.chk:checked').forEach(x => db.collection("reportes").doc(x.dataset.id).delete());
            } 
        }
    </script>
</body>
</html>

































