<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Josefina - Panel de Control</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --naranja: #ff6600; --oscuro: #222; --verde: #27ae60; --azul: #2980b9; --rojo: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        #bloqueo { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--oscuro); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .card-login { background:white; padding:40px; border-radius:25px; text-align:center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
        .main-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 1400px; margin: auto; display:none; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--naranja); padding-bottom: 15px; margin-bottom: 20px; }
        .logo { font-family: 'Brush Script MT', cursive; font-size: 38px; color: var(--naranja); text-shadow: 1px 1px 0px #000; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--oscuro); color: white; padding: 15px; text-align: left; font-size: 13px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn { border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-ojo { background: var(--azul); }
        .btn-pdf { background: var(--rojo); }
        .btn-negro { background: var(--oscuro); }
        .btn-ws { background: #25d366; color: white; text-decoration: none; padding: 5px 8px; border-radius: 6px; font-size: 11px; margin-left: 5px; font-weight: bold; display: inline-block; }
        .badge { padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; color: white; cursor: pointer; border: none; text-transform: uppercase; width: 110px; text-align: center; }
        .bg-vacio { background: var(--verde); }
        .bg-cargado { background: var(--naranja); }
        
        /* MODALES */
        .modal-detalles { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:11000; }
        .detalles-box { background:white; padding:30px; border-radius:20px; width:90%; max-width:600px; text-align:left; max-height: 90vh; overflow-y: auto; position: relative; }
        .linea-dato { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 15px; color: #333; }
        .input-edit { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 14px; box-sizing: border-box; }
        .item-chofer { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="bloqueo">
        <div class="card-login">
            <div class="logo">La Josefina</div><br>
            <input type="password" id="pass-adm" placeholder="Clave Administrador" style="padding:15px; width:220px; border-radius:12px; border:2px solid #ddd; font-size: 18px; text-align:center;"><br><br>
            <button class="btn btn-negro" style="width:100%; height:50px;" onclick="entrar()">ENTRAR AL SISTEMA</button>
        </div>
    </div>

    <div id="modal-viaje" class="modal-detalles">
        <div class="detalles-box">
            <h3 style="color:var(--naranja); margin-top:0;">Editar Informaci√≥n del Viaje</h3>
            <div id="cont-viaje"></div><br>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-negro" style="flex:1" onclick="cerrarVentana('modal-viaje')">CERRAR</button>
                <button class="btn" style="background:var(--verde); flex:1" onclick="guardarCambiosViaje()">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="modal-choferes" class="modal-detalles">
        <div class="detalles-box" style="max-width: 500px;">
            <h3 style="color:var(--naranja); margin-top:0;">Gesti√≥n de Choferes</h3>
            <div id="lista-choferes-cont" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;"></div>
            <hr>
            <h4>Agregar Nuevo Chofer</h4>
            <input type="text" id="nuevo-nombre" class="input-edit" placeholder="Nombre completo">
            <input type="text" id="nueva-clave" class="input-edit" placeholder="Clave">
            <input type="text" id="nuevo-tel" class="input-edit" placeholder="WhatsApp (Ej: 5493584123456)"><br><br>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-negro" style="flex:1" onclick="cerrarVentana('modal-choferes')">CERRAR</button>
                <button class="btn" style="background:var(--verde); flex:1" onclick="agregarChofer()">AGREGAR</button>
            </div>
        </div>
    </div>

    <div class="main-card" id="app">
        <div class="header">
            <div class="logo">La Josefina</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-negro" onclick="abrirGestionChoferes()">GESTIONAR CHOFERES</button>
                <button class="btn btn-pdf" style="background:#444;" onclick="borrarSels()">BORRAR SELECCIONADOS</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="seleccionarTodo(this)"></th>
                    <th>FECHA / HORA</th>
                    <th>ESTADO</th>
                    <th>CHOFER</th>
                    <th>TRANSPORTE</th>
                    <th>PATENTES</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tabla-body"></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let reporteIdActual = null;
        let diccChoferes = {};

        function entrar() { if(document.getElementById('pass-adm').value === "1234") { document.getElementById('bloqueo').style.display='none'; document.getElementById('app').style.display='block'; cargarReportes(); syncChoferes(); } }

        function syncChoferes() { 
            db.collection("accesos_choferes").onSnapshot(s => { 
                diccChoferes = {};
                s.forEach(doc => { diccChoferes[doc.id] = doc.data(); });
                if(document.getElementById('modal-choferes').style.display === 'flex') dibujarListaChoferes();
            }); 
        }

        function cargarReportes() {
            db.collection("reportes").orderBy("fecha", "desc").onSnapshot(snap => {
                const t = document.getElementById('tabla-body'); t.innerHTML = "";
                snap.forEach(doc => {
                    const r = doc.data(); r.id = doc.id;
                    const claseEstado = r.estado === 'VAC√çO' ? 'bg-vacio' : 'bg-cargado';
                    const tel = diccChoferes[r.chofer]?.telefono || "";
                    const ws = tel ? `<a class="btn-ws" target="_blank" href="https://wa.me/${tel}?text=Hola%20${r.chofer},%20hay%20un%20error%20en%20el%20ticket.">WS</a>` : "";
                    t.innerHTML += `<tr>
                        <td><input type="checkbox" class="chk" data-id="${r.id}"></td>
                        <td>${r.fecha}</td>
                        <td><button class="badge ${claseEstado}" onclick="cambiarEstado('${r.id}','${r.estado}')">${r.estado}</button></td>
                        <td><b>${r.chofer}</b> ${ws}</td>
                        <td>${r.transporte || '--'}</td>
                        <td>${r.chasis || '--'} / ${r.acoplado || '--'}</td>
                        <td><button class="btn btn-ojo" onclick="verDetalles('${r.id}')">üëÅÔ∏è</button></td>
                    </tr>`;
                });
            });
        }

        // GESTI√ìN DE VIAJES
        function verDetalles(id) {
            reporteIdActual = id;
            db.collection("reportes").doc(id).get().then(doc => {
                const d = doc.data();
                document.getElementById('cont-viaje').innerHTML = `
                    <label>Transporte</label><input id="e-trans" class="input-edit" value="${d.transporte || ''}">
                    <label>Patente Chasis</label><input id="e-ch" class="input-edit" value="${d.chasis || ''}">
                    <label>Patente Acoplado</label><input id="e-ac" class="input-edit" value="${d.acoplado || ''}">
                    <label>Fecha</label><input id="e-fecha" class="input-edit" value="${d.fecha || ''}">
                `;
                document.getElementById('modal-viaje').style.display = 'flex';
            });
        }

        async function guardarCambiosViaje() {
            await db.collection("reportes").doc(reporteIdActual).update({
                transporte: document.getElementById('e-trans').value,
                chasis: document.getElementById('e-ch').value,
                acoplado: document.getElementById('e-ac').value,
                fecha: document.getElementById('e-fecha').value
            });
            cerrarVentana('modal-viaje');
        }

        // GESTI√ìN DE CHOFERES (RECUADRO ESTILO OJO)
        function abrirGestionChoferes() {
            dibujarListaChoferes();
            document.getElementById('modal-choferes').style.display = 'flex';
        }

        function dibujarListaChoferes() {
            const cont = document.getElementById('lista-choferes-cont');
            cont.innerHTML = "";
            for (let id in diccChoferes) {
                cont.innerHTML += `
                    <div class="item-chofer">
                        <div style="flex:1">
                            <b>${id}</b><br>
                            <small>Clave: ${diccChoferes[id].clave} | Tel: ${diccChoferes[id].telefono || '---'}</small>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn" style="background:var(--azul); padding:5px 10px;" onclick="cargarEdicionChofer('${id}')">‚úé</button>
                            <button class="btn" style="background:var(--rojo); padding:5px 10px;" onclick="eliminarChofer('${id}')">‚úñ</button>
                        </div>
                    </div>
                `;
            }
        }

        function agregarChofer() {
            const n = document.getElementById('nuevo-nombre').value.trim();
            const c = document.getElementById('nueva-clave').value.trim();
            const t = document.getElementById('nuevo-tel').value.trim();
            if(n && c) {
                db.collection("accesos_choferes").doc(n).set({ clave: c, telefono: t });
                document.getElementById('nuevo-nombre').value = ""; document.getElementById('nueva-clave').value = ""; document.getElementById('nuevo-tel').value = "";
            } else { alert("Nombre y Clave son obligatorios"); }
        }

        function cargarEdicionChofer(id) {
            const c = diccChoferes[id];
            document.getElementById('nuevo-nombre').value = id;
            document.getElementById('nueva-clave').value = c.clave;
            document.getElementById('nuevo-tel').value = c.telefono || "";
            alert("Los datos se cargaron abajo para editar. Modificalos y pulsa AGREGAR (se sobrescribir√°).");
        }

        function eliminarChofer(id) {
            if(confirm("¬øBorrar chofer " + id + "?")) db.collection("accesos_choferes").doc(id).delete();
        }

        function cerrarVentana(id) { document.getElementById(id).style.display = 'none'; }
        async function cambiarEstado(id, est) { await db.collection("reportes").doc(id).update({ estado: est === 'VAC√çO' ? 'CARGADO' : 'VAC√çO' }); }
        function seleccionarTodo(s) { document.querySelectorAll('.chk').forEach(x => x.checked = s.checked); }
        function borrarSels() { if(confirm("¬øBorrar seleccionados?")) { document.querySelectorAll('.chk:checked').forEach(x => db.collection("reportes").doc(x.dataset.id).delete()); } }
    </script>
</body>
</html>



















































