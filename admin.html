<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Administrativo - Transporte La Josefina</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --naranja: #ff6600; --oscuro: #1a1a1a; }
        body { font-family: 'Segoe UI', sans-serif; background: #ffffff; margin: 0; padding: 0; }
        
        /* LOGIN REFORZADO */
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--oscuro); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 9999;
        }
        .logo-login { 
            font-size: 45px; font-weight: 900; color: var(--naranja); 
            text-shadow: 3px 3px 0px #000, -3px -3px 0px #000, 3px -3px 0px #000, -3px 3px 0px #000;
            margin-bottom: 30px; text-align: center; line-height: 1;
        }
        .input-login { padding: 15px; font-size: 20px; border-radius: 12px; border: none; text-align: center; width: 220px; margin-bottom: 20px; }

        /* CONTENIDO */
        #contenido-principal { display: none; padding: 20px; }

        .header { background: #333; color: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 4px solid var(--naranja); }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #444; color: white; font-size: 11px; text-transform: uppercase; }
        
        .txt-vacio { color: #28a745 !important; font-weight: 900; text-transform: uppercase; }
        .txt-cargado { color: #dc3545 !important; font-weight: 900; text-transform: uppercase; }

        /* MODALES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 90%; max-width: 450px; border-radius: 15px; position: relative; }
        .ficha-mini { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .ficha-bloque { background: #f9f9f9; padding: 12px; border-radius: 10px; border-left: 5px solid var(--naranja); border: 1px solid #ddd; }
        .ficha-bloque label { font-size: 9px; color: #888; font-weight: bold; display: block; text-transform: uppercase; }
        .ficha-bloque span { font-size: 15px; font-weight: bold; color: #333; }

        #visor-foto { background: #333; padding: 20px; border-radius: 10px; text-align: center; min-height: 200px; }
        #img-ticket { max-width: 100%; height: auto; }

        .btn-crear { background: var(--naranja); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-ojo { background: #f0f0f0; border: 1px solid #ccc; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="logo-login">TRANSPORTE<br>LA JOSEFINA</div>
        <input type="password" id="pin-input" class="input-login" placeholder="PIN DE ACCESO" onkeypress="if(event.key==='Enter') verificarLogin()">
        <button class="btn-crear" style="padding: 15px 40px; font-size: 18px;" onclick="verificarLogin()">INGRESAR</button>
    </div>

    <div id="contenido-principal">
        <div class="header">
            <h2 style="margin:0">PANEL CONTROL - LA JOSEFINA</h2>
            <button class="btn-crear" onclick="toggleGestion()">‚öôÔ∏è GESTI√ìN</button>
        </div>

        <div id="box-gestion" style="display:none; background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #ddd;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px;">
                <input type="text" id="u-nom" placeholder="Usuario">
                <input type="text" id="u-pin" placeholder="PIN">
                <input type="text" id="u-tel" placeholder="WhatsApp">
                <button class="btn-crear" onclick="guardarChofer()">GUARDAR</button>
            </div>
            <table style="width:100%; margin-top:15px;"><tbody id="lista-choferes"></tbody></table>
        </div>

        <table>
            <thead>
                <tr>
                    <th>FECHA / HORA</th>
                    <th>ESTADO</th>
                    <th>CHOFER</th>
                    <th>TRANSPORTE</th>
                    <th>DATOS</th>
                    <th>TICKET</th>
                </tr>
            </thead>
            <tbody id="lista-reportes"></tbody>
        </table>
    </div>

    <div id="modalDatos" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer; font-weight:bold; font-size:24px;" onclick="cerrarModales()">‚úñ</span>
            <h3 style="margin-top:0; border-bottom: 2px solid var(--naranja);">FICHA DEL VIAJE</h3>
            <div id="ficha-mini" class="ficha-mini"></div>
        </div>
    </div>

    <div id="modalPDF" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <span style="float:right; cursor:pointer; font-weight:bold; font-size:24px;" onclick="cerrarModales()">‚úñ</span>
            <h3>VISOR DE TICKET</h3>
            <div style="display:flex; gap:20px; background:#eee; padding:10px; border-radius:10px; margin-bottom:10px;">
                <div>Brillo <input type="range" id="brillo" min="50" max="250" value="100" oninput="aplicarScanner()"></div>
                <div>Contraste <input type="range" id="contraste" min="50" max="250" value="130" oninput="aplicarScanner()"></div>
            </div>
            <div id="visor-foto"><img id="img-ticket" src=""></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-crear" style="background:#28a745; flex:1" onclick="descargarPDF()">üì• GUARDAR PDF A4</button>
                <button class="btn-crear" style="background:#dc3545; flex:1" onclick="pedirReenvio()">‚ö†Ô∏è RECLAMAR FOTO</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyC...", 
            authDomain: "control-logistica-2026.firebaseapp.com", 
            projectId: "control-logistica-2026", 
            appId: "1:389274295324:web:04467597157833633e467d" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let actual = null, idAct = "";

        function verificarLogin() {
            const pin = document.getElementById('pin-input').value;
            if(pin === "1234") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('contenido-principal').style.display = 'block';
                cargarDatos();
            } else { alert("PIN Incorrecto"); }
        }

        function cargarDatos() {
            db.collection("reportes").onSnapshot(snap => {
                const l = document.getElementById('lista-reportes'); 
                l.innerHTML = "";
                let reportes = [];
                snap.forEach(doc => { reportes.push({id: doc.id, ...doc.data()}); });

                // ORDEN: Vac√≠o arriba (por hora), Cargado abajo
                reportes.sort((a, b) => {
                    const estA = (a.estado === 'VAC√çO') ? 0 : 1;
                    const estB = (b.estado === 'VAC√çO') ? 0 : 1;
                    if (estA !== estB) return estA - estB;
                    let fechaA = a.fecha ? new Date(a.fecha.split(', ').reverse().join(' ')) : new Date(0);
                    let fechaB = b.fecha ? new Date(b.fecha.split(', ').reverse().join(' ')) : new Date(0);
                    return fechaA - fechaB;
                });

                reportes.forEach(d => {
                    const claseEstado = d.estado === 'VAC√çO' ? 'txt-vacio' : 'txt-cargado';
                    const tieneFoto = (d.fotos && d.fotos.length > 0);
                    let btnPdf = tieneFoto ? `<button class="btn-crear" style="padding:5px 10px;" onclick="verP('${d.id}')">PDF</button>` : "-";
                    
                    l.innerHTML += `
                        <tr>
                            <td>${d.fecha || 'Sin fecha'}</td>
                            <td>
                                <select onchange="cambiarEstado('${d.id}', this.value)" class="${claseEstado}" style="border:none; background:none; cursor:pointer;">
                                    <option value="VAC√çO" ${d.estado === 'VAC√çO' ? 'selected' : ''}>VAC√çO</option>
                                    <option value="CARGADO" ${d.estado === 'CARGADO' ? 'selected' : ''}>CARGADO</option>
                                </select>
                            </td>
                            <td><b>${d.chofer_nombre || 'S/N'}</b></td>
                            <td>${d.transporte || 'S/T'}</td>
                            <td><button class="btn-ojo" onclick="verD('${d.id}')">üëÅÔ∏è</button></td>
                            <td>${btnPdf}</td>
                        </tr>`;
                });
            });
        }

        async function verD(id) {
            const doc = await db.collection("reportes").doc(id).get(); 
            const d = doc.data();
            document.getElementById('ficha-mini').innerHTML = `
                <div class="ficha-bloque"><label>Empresa</label><span>${d.transporte || '-'}</span><br><label>CUIT</label><span>${d.cuit_trans || '-'}</span></div>
                <div class="ficha-bloque"><label>Chofer</label><span>${d.chofer_nombre || '-'}</span><br><label>CUIL</label><span>${d.chofer_cuil || '-'}</span></div>
                <div class="ficha-bloque"><label>Chasis</label><span>${d.chasis || '-'}</span></div>
                <div class="ficha-bloque"><label>Acoplado</label><span>${d.acoplado || '-'}</span></div>
                <div class="ficha-bloque"><label>Tipo</label><span>${d.equipo || '-'}</span></div>`;
            document.getElementById('modalDatos').style.display = 'block';
        }

        async function verP(id) {
            idAct = id; const doc = await db.collection("reportes").doc(id).get(); actual = doc.data();
            document.getElementById('img-ticket').src = actual.fotos[0];
            document.getElementById('modalPDF').style.display = 'block';
            aplicarScanner();
        }

        function aplicarScanner() {
            const b = document.getElementById('brillo').value;
            const c = document.getElementById('contraste').value;
            document.getElementById('img-ticket').style.filter = `brightness(${b}%) contrast(${c}%) grayscale(100%)`;
        }

        function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const img = document.getElementById('img-ticket');
            const canvas = document.createElement('canvas');
            const imgObj = new Image();
            imgObj.crossOrigin = "anonymous";
            imgObj.src = img.src;
            imgObj.onload = () => {
                canvas.width = imgObj.width; canvas.height = imgObj.height;
                const ctx = canvas.getContext('2d');
                ctx.filter = img.style.filter;
                ctx.drawImage(imgObj, 0, 0);
                doc.setFontSize(8);
                doc.text(`${actual.transporte} - ${actual.chofer_nombre}`, 10, 8);
                doc.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 5, 12, 200, 275);
                doc.save(`Ticket_${actual.chofer_nombre}.pdf`);
            };
        }

        async function pedirReenvio() {
            const cDoc = await db.collection("accesos_choferes").doc(actual.chofer).get();
            const hora = actual.fecha ? actual.fecha.split(', ')[1] : '';
            const msg = `Hola ${actual.chofer_nombre}, necesito que me reenv√≠es la imagen que me pasaste a las ${hora}.`;
            window.open(`https://api.whatsapp.com/send?phone=${cDoc.data().telefono}&text=${encodeURIComponent(msg)}`, '_blank');
        }

        function cambiarEstado(id, n) { db.collection("reportes").doc(id).update({ estado: n }); }
        function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function toggleGestion() { const b = document.getElementById('box-gestion'); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }
        
        async function guardarChofer() {
            const u = document.getElementById('u-nom').value.toLowerCase();
            const p = document.getElementById('u-pin').value;
            const t = document.getElementById('u-tel').value;
            if(u && p && t) await db.collection("accesos_choferes").doc(u).set({ clave: p, telefono: t });
        }
    </script>
</body>
</html>
































































