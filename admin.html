<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo Maestro - Transporte La Josefina</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* =========================================
           VARIABLES DE DISE√ëO HIGH-END
           ========================================= */
        :root {
            --naranja: #ff6600;
            --naranja-brillante: #ff8533;
            --oscuro-puro: #0a0a0a;
            --oscuro-card: #141414;
            --oscuro-hover: #1f1f1f;
            --gris-fondo: #f0f2f5;
            --gris-texto: #65676b;
            --rojo: #ff4d4d;
            --verde: #2ecc71;
            --azul: #007bff;
            --blanco: #ffffff;
            --sombra-pro: 0 20px 40px rgba(0,0,0,0.4);
            --radius-lg: 30px;
            --radius-md: 15px;
            --transicion: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* RESET PROFESIONAL */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(var(--naranja), #993d00); 
            border-radius: 10px; border: 3px solid #000;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--gris-fondo);
            margin: 0; padding: 0; color: #1c1e21;
            overflow-x: hidden; line-height: 1.6;
        }

        /* =========================================
           SISTEMA DE ACCESO (LOGIN)
           ========================================= */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #2c2c2c 0%, var(--oscuro-puro) 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999999; transition: opacity 0.8s ease, visibility 0.8s;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            padding: 70px 50px; border-radius: 45px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--sombra-pro);
            width: 450px; text-align: center;
            animation: emerge 1s ease-out;
        }

        @keyframes emerge {
            0% { opacity: 0; transform: translateY(50px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .logo-josefina {
            font-size: 80px; font-weight: 950; color: var(--naranja);
            text-shadow: 7px 7px 0px #000; line-height: 0.8;
            letter-spacing: -5px; margin-bottom: 50px; text-transform: uppercase;
        }

        .input-pin {
            width: 100%; padding: 25px; font-size: 35px; border-radius: 20px;
            border: none; text-align: center; margin-bottom: 35px;
            background: white; color: var(--oscuro-puro); font-weight: 900;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); letter-spacing: 15px;
        }

        /* =========================================
           ESTRUCTURA DASHBOARD
           ========================================= */
        #contenido-principal { display: none; padding: 50px; max-width: 1800px; margin: 0 auto; }

        .navbar {
            background: var(--oscuro-card); color: white; padding: 40px 60px;
            border-radius: var(--radius-lg); display: flex; justify-content: space-between; align-items: center;
            border-bottom: 12px solid var(--naranja); box-shadow: var(--sombra-pro);
            margin-bottom: 50px; position: sticky; top: 20px; z-index: 1000;
        }

        .nav-info h2 { margin: 0; font-size: 38px; font-weight: 900; letter-spacing: -1px; }
        .nav-info span { color: var(--naranja); font-weight: 800; text-transform: uppercase; font-size: 14px; letter-spacing: 3px; }

        .btn-panel {
            padding: 18px 30px; border-radius: 18px; border: none; cursor: pointer;
            font-weight: 900; text-transform: uppercase; font-size: 13px;
            transition: var(--transicion); display: flex; align-items: center; gap: 10px;
        }

        .btn-naranja { background: var(--naranja); color: white; box-shadow: 0 10px 20px rgba(255,102,0,0.3); }
        .btn-naranja:hover { background: var(--naranja-brillante); transform: translateY(-4px); }

        .btn-dark { background: #333; color: white; }
        .btn-dark:hover { background: #000; }

        /* =========================================
           TABLA DE DATOS MAESTRA
           ========================================= */
        .card-table {
            background: var(--blanco); border-radius: 40px; padding: 40px;
            box-shadow: 0 15px 60px rgba(0,0,0,0.05); border: 1px solid #e1e4e8;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 15px; }

        th {
            padding: 25px; color: #adb5bd; text-transform: uppercase;
            font-size: 13px; font-weight: 850; letter-spacing: 2px; text-align: left;
        }

        td {
            padding: 30px 25px; background: #fff;
            border-top: 1.5px solid #f8f9fa; border-bottom: 1.5px solid #f8f9fa;
            font-size: 17px; font-weight: 650; transition: var(--transicion);
        }

        td:first-child { border-left: 1.5px solid #f8f9fa; border-top-left-radius: 25px; border-bottom-left-radius: 25px; }
        td:last-child { border-right: 1.5px solid #f8f9fa; border-top-right-radius: 25px; border-bottom-right-radius: 25px; }

        tr:hover td { background: #fdfdfd; transform: scale(1.008); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }

        /* ESTADOS DE CARGA */
        .select-status {
            padding: 14px 22px; border-radius: 14px; border: 2.5px solid transparent;
            font-weight: 900; font-size: 14px; cursor: pointer; transition: 0.3s;
        }
        .st-vacio { color: var(--verde); background: rgba(46, 204, 113, 0.1); border-color: var(--verde); }
        .st-cargado { color: var(--rojo); background: rgba(255, 77, 77, 0.1); border-color: var(--rojo); }

        /* =========================================
           MODALES DIN√ÅMICOS (GIGANTES)
           ========================================= */
        .modal-base {
            display: none; position: fixed; z-index: 100000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.96);
            backdrop-filter: blur(15px); overflow-y: auto; padding: 40px 0;
        }

        .modal-body {
            background: white; margin: 0 auto; padding: 60px; width: 94%;
            max-width: 1250px; border-radius: 50px; position: relative;
            box-shadow: 0 60px 200px rgba(0,0,0,0.8);
            animation: modalSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalSlide { from { opacity:0; transform: translateY(100px); } to { opacity:1; transform: translateY(0); } }

        .close-btn {
            position: absolute; right: 50px; top: 40px; font-size: 60px;
            font-weight: 900; color: #ddd; cursor: pointer; transition: 0.3s;
        }
        .close-btn:hover { color: var(--rojo); transform: scale(1.1); }

        /* GRILLA 7 CAMPOS */
        .edit-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 35px;
            background: #fcfcfc; padding: 45px; border-radius: 35px; border: 2px solid #f1f1f1;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label {
            font-size: 14px; font-weight: 900; color: var(--naranja);
            margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1.5px;
        }
        .input-group input {
            padding: 20px; border: 3px solid #eee; border-radius: 20px;
            font-size: 18px; font-weight: 700; transition: 0.3s; background: #fff;
        }
        .input-group input:focus { border-color: var(--naranja); box-shadow: 0 0 20px rgba(255,102,0,0.1); }

        /* SCANNER DE TICKETS */
        .visor-container {
            background: #000; border-radius: 40px; padding: 50px;
            display: flex; flex-direction: column; align-items: center; gap: 40px;
            margin-top: 30px; border: 10px solid #1a1a1a;
        }

        .ticket-img {
            max-width: 100%; border-radius: 15px; box-shadow: 0 0 80px rgba(0,0,0,1);
            border: 2px solid #333; transition: 0.1s;
        }

        .filter-controls {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px;
            background: #f8f9fa; padding: 40px; border-radius: 30px; margin-bottom: 40px;
            border: 1px solid #eee;
        }

        .control-range { display: flex; flex-direction: column; font-weight: 900; font-size: 13px; color: #444; }
        .control-range input { margin-top: 15px; cursor: pointer; accent-color: var(--naranja); }

        /* GESTI√ìN DE ACCESOS */
        #box-config {
            display: none; background: white; padding: 50px; border-radius: 40px;
            border: 6px solid var(--naranja); margin-bottom: 50px; box-shadow: var(--sombra-pro);
        }

        .btn-save-full {
            background: var(--verde); color: white; width: 100%; padding: 28px;
            border-radius: 22px; border: none; font-weight: 950; font-size: 20px;
            cursor: pointer; margin-top: 45px; text-transform: uppercase;
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.3); transition: 0.4s;
        }
        .btn-save-full:hover { transform: scale(1.02); filter: brightness(1.1); }

        .btn-del {
            background: none; border: none; color: #ddd; font-size: 24px; cursor: pointer; transition: 0.3s;
        }
        .btn-del:hover { color: var(--rojo); transform: rotate(90deg); }

        /* ANIMACIONES DE CARGA */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-container">
            <div class="logo-josefina">TRANSPORTE<br>LA JOSEFINA</div>
            <p style="color:rgba(255,255,255,0.4); font-weight:800; letter-spacing:5px; margin-bottom:40px; font-size:14px;">ADMINISTRATION SYSTEM 2026</p>
            <input type="password" id="admin-pin" class="input-pin" placeholder="****" maxlength="4" onkeypress="if(event.key==='Enter') loginAdmin()">
            <button class="btn-panel btn-naranja" onclick="loginAdmin()" style="width:100%; padding:25px; justify-content:center; font-size:16px;">AUTORIZAR INGRESO</button>
        </div>
    </div>

    <div id="contenido-principal">
        <div class="navbar">
            <div class="nav-info">
                <span>Centro de Comando Log√≠stico</span>
                <h2>PANEL ADMINISTRATIVO</h2>
            </div>
            <div style="display:flex; gap:25px;">
                <button class="btn-panel btn-dark" onclick="toggleConfig()">‚öôÔ∏è GESTIONAR TERMINALES</button>
                <button class="btn-panel btn-naranja" onclick="exitApp()">SALIR DEL SISTEMA</button>
            </div>
        </div>

        <div id="box-config">
            <h3 style="font-weight:900; text-transform:uppercase; margin-bottom:40px; font-size:24px; color:var(--oscuro-puro); border-left:10px solid var(--naranja); padding-left:20px;">Registro de Choferes Autorizados</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:30px; margin-bottom:40px;">
                <div class="input-group"><label>Nombre del Chofer</label><input type="text" id="add-nom" placeholder="Ej: Roberto Gomez"></div>
                <div class="input-group"><label>PIN de Acceso</label><input type="text" id="add-pin" placeholder="4 d√≠gitos"></div>
                <div class="input-group"><label>L√≠nea WhatsApp</label><input type="text" id="add-tel" placeholder="549351000000"></div>
                <button class="btn-panel btn-naranja" onclick="saveChofer()" style="height:73px; margin-top:33px;">REGISTRAR</button>
            </div>
            <div class="card-table">
                <table>
                    <thead>
                        <tr><th>CHOFER</th><th>PIN ASIGNADO</th><th>TEL√âFONO</th><th>ACCI√ìN</th></tr>
                    </thead>
                    <tbody id="lista-choferes-db"></tbody>
                </table>
            </div>
        </div>

        <div class="card-table">
            <table>
                <thead>
                    <tr>
                        <th>TURNO REGISTRO</th>
                        <th>ESTADO DE CARGA</th>
                        <th>CHOFER</th>
                        <th>EMPRESA TRANSPORTE</th>
                        <th>EXPEDIENTE</th>
                        <th>TICKET DIGITAL</th>
                        <th>BORRAR</th>
                    </tr>
                </thead>
                <tbody id="tbody-reportes"></tbody>
            </table>
        </div>
    </div>

    <div id="modalEdicion" class="modal-base">
        <div class="modal-body">
            <span class="close-btn" onclick="closeModals()">√ó</span>
            <h2 style="font-weight:950; border-bottom:8px solid var(--naranja); padding-bottom:20px; margin-top:0; font-size:35px;">FICHA T√âCNICA DE VIAJE</h2>
            
            <div class="edit-grid">
                <div class="input-group"><label>Empresa de Transporte</label><input type="text" id="ed-trans"></div>
                <div class="input-group"><label>CUIT de la Empresa</label><input type="text" id="ed-cuit"></div>
                <div class="input-group"><label>Nombre del Chofer</label><input type="text" id="ed-nom"></div>
                <div class="input-group"><label>CUIL del Chofer</label><input type="text" id="ed-cuil"></div>
                <div class="input-group"><label>Patente Chasis</label><input type="text" id="ed-chasis"></div>
                <div class="input-group"><label>Patente Acoplado</label><input type="text" id="ed-acoplado"></div>
                <div class="input-group" style="grid-column: span 2;"><label>Tipo de Equipo / Configuraci√≥n</label><input type="text" id="ed-equipo"></div>
            </div>

            <div style="margin-top:40px; padding:35px; background:rgba(0,123,255,0.05); border-radius:30px; border:4px dashed var(--azul);">
                <label style="font-weight:900; color:var(--azul); display:block; margin-bottom:15px; font-size:18px;">üîÑ ACTUALIZAR O AGREGAR FOTO (REENV√çO WHATSAPP)</label>
                <input type="file" id="up-foto-manual" accept="image/*" style="font-weight:bold; font-size:16px;">
                <p style="font-size:13px; color:#666; margin-top:15px; font-weight:600;">* Si el chofer te mand√≥ la foto por WhatsApp, subila ac√° para que el reporte quede completo sin duplicarse.</p>
            </div>

            <button class="btn-save-full" onclick="saveGlobalChanges()">‚úÖ SINCRONIZAR CAMBIOS EN BASE DE DATOS</button>
        </div>
    </div>

    <div id="modalVisor" class="modal-base">
        <div class="modal-body">
            <span class="close-btn" onclick="closeModals()">√ó</span>
            <h2 style="font-weight:950; margin-bottom:40px; font-size:35px;">PROCESADOR DIGITAL DE TICKETS</h2>
            
            <div class="filter-controls">
                <div class="control-range">LUMINOSIDAD <input type="range" id="sk-bri" min="50" max="250" value="100" oninput="applyScannerFilters()"></div>
                <div class="control-range">CONTRASTE <input type="range" id="sk-con" min="50" max="350" value="100" oninput="applyScannerFilters()"></div>
                <div class="control-range">LIMPIEZA FONDO <input type="range" id="sk-lim" min="0" max="100" value="0" oninput="applyScannerFilters()"></div>
                <div class="control-range">INTENSIDAD TINTA <input type="range" id="sk-tin" min="0" max="100" value="0" oninput="applyScannerFilters()"></div>
            </div>

            <div id="visor-galeria-fotos" class="visor-container">
                </div>

            <div style="display:flex; gap:30px; margin-top:50px;">
                <button class="btn-save-full" onclick="buildPDF()" style="flex:2; margin:0; background:var(--oscuro-puro);">üì• GENERAR DOCUMENTO PDF A4</button>
                <button class="btn-save-full" onclick="waClaim()" style="flex:1; margin:0; background:var(--verde); display:flex; align-items:center; justify-content:center; gap:15px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="25" style="filter:invert(1);"> RECLAMAR
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE SEGURIDAD FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentRef = null, globalID = "";

        // CONTROL DE ACCESO
        function loginAdmin() {
            const p = document.getElementById('admin-pin').value;
            if(p === "1234") {
                localStorage.setItem('josefina_session_token', 'validated_2026');
                startDashboard();
            } else { alert("PIN INCORRECTO"); }
        }

        window.onload = () => {
            if(localStorage.getItem('josefina_session_token') === 'validated_2026') startDashboard();
        };

        function startDashboard() {
            document.getElementById('login-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('contenido-principal').style.display = 'block';
                syncLiveReports();
                syncLiveChoferes();
            }, 800);
        }

        function exitApp() { localStorage.removeItem('josefina_session_token'); location.reload(); }

        // SINCRONIZACI√ìN DE REPORTES (MULTIFOTO + FLEXIBILIDAD)
        function syncLiveReports() {
            db.collection("reportes").onSnapshot(snap => {
                const tbody = document.getElementById('tbody-reportes');
                tbody.innerHTML = "";
                let reports = [];

                snap.forEach(doc => {
                    let r = doc.data();
                    if(!r.fecha) {
                        const n = new Date();
                        r.fecha = n.toLocaleDateString('es-AR') + ", " + n.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
                        db.collection("reportes").doc(doc.id).update({fecha: r.fecha});
                    }
                    reports.push({id: doc.id, ...r});
                });

                // ORDENAMIENTO CR√çTICO: VAC√çOS ARRIBA
                reports.sort((a,b) => {
                    if (a.estado === 'VAC√çO' && b.estado === 'CARGADO') return -1;
                    if (a.estado === 'CARGADO' && b.estado === 'VAC√çO') return 1;
                    return (a.fecha || '').localeCompare(b.fecha || '');
                });

                reports.forEach(r => {
                    const style = r.estado === 'VAC√çO' ? 'st-vacio' : 'st-cargado';
                    const cFotos = Array.isArray(r.fotos) ? r.fotos.length : (r.fotos ? 1 : 0);
                    const btnTicket = cFotos > 0 
                        ? `<button class="btn-panel btn-dark" onclick="openVisor('${r.id}')">üìÑ TICKET (${cFotos})</button>`
                        : `<span style="color:#ccc; font-size:12px; font-weight:900;">SIN IMAGEN</span>`;

                    tbody.innerHTML += `
                        <tr>
                            <td><span style="background:#f0f2f5; padding:10px 15px; border-radius:12px; font-size:14px; font-weight:800;">${r.fecha}</span></td>
                            <td><select class="select-status ${style}" onchange="updateLiveStatus('${r.id}', this.value)">
                                <option value="VAC√çO" ${r.estado=='VAC√çO'?'selected':''}>VAC√çO</option>
                                <option value="CARGADO" ${r.estado=='CARGADO'?'selected':''}>CARGADO</option>
                            </select></td>
                            <td><b style="color:var(--oscuro-puro)">${r.chofer_nombre || 'S/N'}</b></td>
                            <td style="font-size:14px; color:var(--gris-texto);">${r.transporte || '---'}</td>
                            <td><button class="btn-panel btn-naranja" onclick="openFicha('${r.id}')">EDITAR</button></td>
                            <td>${btnTicket}</td>
                            <td><button class="btn-del" onclick="deleteReport('${r.id}')">üóëÔ∏è</button></td>
                        </tr>`;
                });
            });
        }

        // L√ìGICA DE EDICI√ìN Y PARCHADO (MULTIFOTO)
        async function openFicha(id) {
            globalID = id;
            const doc = await db.collection("reportes").doc(id).get();
            const d = doc.data();
            document.getElementById('ed-trans').value = d.transporte || "";
            document.getElementById('ed-cuit').value = d.cuit_trans || "";
            document.getElementById('ed-nom').value = d.chofer_nombre || "";
            document.getElementById('ed-cuil').value = d.chofer_cuil || "";
            document.getElementById('ed-chasis').value = d.chasis || "";
            document.getElementById('ed-acoplado').value = d.acoplado || "";
            document.getElementById('ed-equipo').value = d.equipo || "";
            document.getElementById('modalEdicion').style.display = 'block';
        }

        async function saveGlobalChanges() {
            const fileInput = document.getElementById('up-foto-manual').files[0];
            let updateData = {
                transporte: document.getElementById('ed-trans').value,
                cuit_trans: document.getElementById('ed-cuit').value,
                chofer_nombre: document.getElementById('ed-nom').value,
                chofer_cuil: document.getElementById('ed-cuil').value,
                chasis: document.getElementById('ed-chasis').value,
                acoplado: document.getElementById('ed-acoplado').value,
                equipo: document.getElementById('ed-equipo').value
            };

            if(fileInput) {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const docSnap = await db.collection("reportes").doc(globalID).get();
                    let currentPhotos = docSnap.data().fotos || [];
                    if(!Array.isArray(currentPhotos)) currentPhotos = [currentPhotos];
                    currentPhotos.push(reader.result); // AGREGAR FOTO EXTRA SIN BORRAR LAS ANTERIORES
                    updateData.fotos = currentPhotos;
                    await db.collection("reportes").doc(globalID).update(updateData);
                    closeModals();
                };
                reader.readAsDataURL(fileInput);
            } else {
                await db.collection("reportes").doc(globalID).update(updateData);
                closeModals();
            }
        }

        // VISOR SCANNER MULTI-IMAGEN
        async function openVisor(id) {
            const doc = await db.collection("reportes").doc(id).get();
            currentRef = {id: doc.id, ...doc.data()};
            const galeria = document.getElementById('visor-galeria-fotos');
            galeria.innerHTML = "";
            
            const list = Array.isArray(currentRef.fotos) ? currentRef.fotos : [currentRef.fotos];
            list.forEach(url => {
                galeria.innerHTML += `<img src="${url}" class="ticket-img">`;
            });

            document.getElementById('modalVisor').style.display = 'block';
            document.getElementById('sk-bri').value = 100;
            document.getElementById('sk-con').value = 100;
            setTimeout(applyScannerFilters, 150);
        }

        function applyScannerFilters() {
            const b = document.getElementById('sk-bri').value, c = document.getElementById('sk-con').value, l = document.getElementById('sk-lim').value, t = document.getElementById('sk-tin').value;
            const filter = `grayscale(100%) brightness(${b}%) contrast(${c}%) brightness(${100 + parseInt(l)}%) saturate(${100 + parseInt(t)}%)`;
            document.querySelectorAll('.ticket-img').forEach(img => img.style.filter = filter);
        }

        function buildPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgs = document.querySelectorAll('.ticket-img');
            
            imgs.forEach((img, i) => {
                const canvas = document.createElement('canvas');
                const obj = new Image();
                obj.crossOrigin = "anonymous";
                obj.src = img.src;
                obj.onload = () => {
                    canvas.width = obj.width; canvas.height = obj.height;
                    const ctx = canvas.getContext('2d');
                    ctx.filter = img.style.filter;
                    ctx.drawImage(obj, 0, 0);
                    if(i > 0) pdf.addPage();
                    pdf.setFontSize(10);
                    pdf.text(`LA JOSEFINA - TICKET DE CARGA - ${currentRef.chofer_nombre} - ${currentRef.fecha}`, 10, 10);
                    pdf.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 5, 15, 200, 275);
                    if(i === imgs.length - 1) pdf.save(`TICKET_${currentRef.chofer_nombre}.pdf`);
                };
            });
        }

        async function waClaim() {
            const doc = await db.collection("accesos_choferes").doc(currentRef.chofer).get();
            if(doc.exists) {
                const t = doc.data().telefono;
                const m = `Hola ${currentRef.chofer_nombre}, por favor reenv√≠ame el ticket del viaje del ${currentRef.fecha} porque no es legible. Gracias.`;
                window.open(`https://api.whatsapp.com/send?phone=${t}&text=${encodeURIComponent(m)}`, '_blank');
            }
        }

        // GESTI√ìN DE CHOFERES
        function syncLiveChoferes() {
            db.collection("accesos_choferes").onSnapshot(snap => {
                const list = document.getElementById('lista-choferes-db');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `<tr><td><b>${doc.id.toUpperCase()}</b></td><td><code>${d.clave}</code></td><td>${d.telefono}</td><td><button class="btn-del" onclick="delChofer('${doc.id}')">X</button></td></tr>`;
                });
            });
        }

        async function saveChofer() {
            const n = document.getElementById('add-nom').value.toLowerCase(), p = document.getElementById('add-pin').value, t = document.getElementById('add-tel').value;
            if(n && p && t) {
                await db.collection("accesos_choferes").doc(n).set({ clave: p, telefono: t });
                document.getElementById('add-nom').value = ""; document.getElementById('add-pin').value = ""; document.getElementById('add-tel').value = "";
            }
        }

        // UTILIDADES
        function closeModals() { document.querySelectorAll('.modal-base').forEach(m => m.style.display = 'none'); }
        function toggleConfig() { const b = document.getElementById('box-config'); b.style.display = b.style.display==='none'?'block':'none'; }
        function updateLiveStatus(id, v) { db.collection("reportes").doc(id).update({ estado: v }); }
        async function deleteReport(id) { if(confirm("¬øELIMINAR DEFINITIVAMENTE ESTE TURNO?")) await db.collection("reportes").doc(id).delete(); }
        async function delChofer(id) { if(confirm("¬øELIMINAR ACCESO?")) await db.collection("accesos_choferes").doc(id).delete(); }
    </script>
</body>
</html>











































































