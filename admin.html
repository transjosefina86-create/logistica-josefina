<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Administrativo - La Josefina</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .header { background: #333; color: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .box-gestion { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(3, 1fr) auto; gap: 10px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-crear { background: #ff6600; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #444; color: white; font-size: 12px; text-transform: uppercase; }
        .btn-ojo { background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .btn-pdf { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 15px; position: relative; }
        .controles-foto { background: #eee; padding: 15px; border-radius: 10px; display: flex; gap: 20px; margin-bottom: 15px; justify-content: center; }
        #visor-foto { background: #333; padding: 20px; border-radius: 10px; text-align: center; }
        #img-ticket { max-width: 100%; transition: 0.3s; }
        .badge { padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .reclamo { background: #ffc107; color: black; }
        .reenvio { background: #28a745; color: white; }
        .sel-estado { font-weight: bold; border: none; background: #f0f2f5; cursor: pointer; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="header">
        <h2>LA JOSEFINA - PANEL ADMIN</h2>
        <button class="btn-crear" onclick="toggleGestion()">‚öôÔ∏è GESTIONAR CHOFERES</button>
    </div>

    <div id="box-gestion" class="box-gestion" style="display:none;">
        <h3>ALTA DE CHOFERES</h3>
        <div class="grid-inputs">
            <input type="text" id="u-nom" placeholder="Usuario">
            <input type="text" id="u-pin" placeholder="PIN">
            <input type="text" id="u-tel" placeholder="WhatsApp (549...)">
            <button class="btn-crear" onclick="guardarChofer()">GUARDAR</button>
        </div>
        <table style="margin-top:15px;">
            <thead><tr><th>Usuario</th><th>PIN</th><th>WhatsApp</th><th>Acci√≥n</th></tr></thead>
            <tbody id="lista-choferes"></tbody>
        </table>
    </div>

    <div class="seccion">
        <table>
            <thead>
                <tr>
                    <th>Fecha / Hora - Estado</th>
                    <th>Chofer</th>
                    <th>Transporte</th>
                    <th>Datos</th>
                    <th>Aviso / Acci√≥n</th>
                    <th>Ticket</th>
                </tr>
            </thead>
            <tbody id="lista-reportes"></tbody>
        </table>
    </div>

    <div id="modalDatos" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span style="float:right; cursor:pointer;" onclick="cerrarModales()">‚úñ</span>
            <h3>DATOS DEL TRANSPORTE</h3>
            <div id="info-chofer" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
        </div>
    </div>

    <div id="modalPDF" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer;" onclick="cerrarModales()">‚úñ</span>
            <h3>VISOR DE TICKET</h3>
            <div class="controles-foto">
                <div>Brillo <input type="range" id="brillo" min="50" max="200" value="100" oninput="aplicarFiltros()"></div>
                <div>Contraste <input type="range" id="contraste" min="50" max="200" value="100" oninput="aplicarFiltros()"></div>
            </div>
            <div id="visor-foto"><img id="img-ticket" src=""></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-pdf" style="flex:1; padding:15px;" onclick="descargarPDF()">üì• GUARDAR PDF</button>
                <button class="btn-crear" style="flex:1; background:#dc3545;" onclick="pedirReenvio()">‚ö†Ô∏è RECLAMAR NUEVA FOTO</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let actual = null, idAct = "";

        function toggleGestion() { const b = document.getElementById('box-gestion'); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }

        async function guardarChofer() {
            const u = document.getElementById('u-nom').value.toLowerCase();
            const p = document.getElementById('u-pin').value;
            const t = document.getElementById('u-tel').value;
            if(u && p && t) await db.collection("accesos_choferes").doc(u).set({ clave: p, telefono: t });
        }

        db.collection("accesos_choferes").onSnapshot(snap => {
            const l = document.getElementById('lista-choferes'); l.innerHTML = "";
            snap.forEach(doc => { l.innerHTML += `<tr><td>${doc.id}</td><td>${doc.data().clave}</td><td>${doc.data().telefono}</td><td><button onclick="borrarC('${doc.id}')">‚ùå</button></td></tr>`; });
        });
        async function borrarC(id) { if(confirm("¬øBorrar?")) await db.collection("accesos_choferes").doc(id).delete(); }

        db.collection("reportes").orderBy("fecha", "desc").onSnapshot(snap => {
            const l = document.getElementById('lista-reportes'); l.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const id = doc.id;
                
                // L√≥gica de avisos
                let aviso = "";
                if(d.estado === "PIDIENDO REENV√çO") aviso = `<span class="badge reclamo">PIDIENDO REENV√çO</span>`;
                else if(d.reenviada) aviso = `<span class="badge reenvio">FOTO REENVIADA</span>`;
                
                // Bot√≥n PDF solo si hay fotos
                let btnPdf = (d.fotos && d.fotos.length > 0) ? `<button class="btn-pdf" onclick="verP('${id}')">üìÑ PDF</button>` : "";

                l.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-size:11px;">${d.fecha}</div>
                            <select class="sel-estado" onchange="cambiarEstado('${id}', this.value)">
                                <option value="VAC√çO" ${d.estado === 'VAC√çO' ? 'selected' : ''}>VAC√çO</option>
                                <option value="CARGADO" ${d.estado === 'CARGADO' || d.estado === 'FOTO REENVIADA' ? 'selected' : ''}>CARGADO</option>
                            </select>
                        </td>
                        <td><b>${d.chofer_nombre}</b></td>
                        <td>${d.transporte}</td>
                        <td><button class="btn-ojo" onclick="verD('${id}')">üëÅÔ∏è</button></td>
                        <td>${aviso}</td>
                        <td>${btnPdf}</td>
                    </tr>`;
            });
        });

        async function cambiarEstado(id, nuevo) {
            await db.collection("reportes").doc(id).update({ estado: nuevo });
        }

        async function verD(id) {
            const doc = await db.collection("reportes").doc(id).get(); const d = doc.data();
            document.getElementById('info-chofer').innerHTML = `<b>Transporte:</b><span>${d.transporte}</span><b>Chofer:</b><span>${d.chofer_nombre}</span><b>Chasis:</b><span>${d.chasis}</span><b>Acoplado:</b><span>${d.acoplado}</span>`;
            document.getElementById('modalDatos').style.display = 'block';
        }

        async function verP(id) {
            idAct = id; const doc = await db.collection("reportes").doc(id).get(); actual = doc.data();
            const img = document.getElementById('img-ticket');
            img.src = actual.fotos[0];
            document.getElementById('modalPDF').style.display = 'block';
            resetFiltros();
        }

        function aplicarFiltros() {
            const b = document.getElementById('brillo').value;
            const c = document.getElementById('contraste').value;
            document.getElementById('img-ticket').style.filter = `brightness(${b}%) contrast(${c}%)`;
        }

        function resetFiltros() { document.getElementById('brillo').value = 100; document.getElementById('contraste').value = 100; aplicarFiltros(); }

        async function pedirReenvio() {
            if(!confirm("¬øRechazar y pedir otra?")) return;
            const cDoc = await db.collection("accesos_choferes").doc(actual.chofer).get();
            await db.collection("reportes").doc(idAct).update({ fotos: [], estado: "PIDIENDO REENV√çO", reenviada: false });
            window.open(`https://api.whatsapp.com/send?phone=${cDoc.data().telefono}&text=Hola ${actual.chofer_nombre}, reenv√≠a la foto de ${actual.transporte} por favor.`, '_blank');
            cerrarModales();
        }

        function descargarPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const img = document.getElementById('img-ticket');
            const canvas = document.createElement('canvas');
            const imgObj = new Image();
            imgObj.src = img.src;
            imgObj.onload = () => {
                canvas.width = imgObj.width; canvas.height = imgObj.height;
                const ctx = canvas.getContext('2d');
                ctx.filter = img.style.filter;
                ctx.drawImage(imgObj, 0, 0);
                doc.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 10, 20, 180, 160);
                doc.save(`Ticket_${actual.chofer_nombre}.pdf`);
            };
        }

        function cerrarModales() { document.getElementById('modalDatos').style.display = 'none'; document.getElementById('modalPDF').style.display = 'none'; }
    </script>
</body>
</html>


























































