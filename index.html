<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transporte La Josefina - Reporte</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 30px; border-radius: 15px; max-width: 450px; width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 8px solid #ff6600; text-align: center; }
        .logo-container { margin-bottom: 20px; }
        .logo-container img { width: 180px; }
        h2 { color: #333; margin-bottom: 25px; font-size: 22px; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: #ff6600; outline: none; box-shadow: 0 0 5px rgba(255,102,0,0.2); }
        button { background-color: #ff6600; color: white; font-weight: bold; border: none; cursor: pointer; transition: background 0.3s; margin-top: 15px; }
        button:hover { background-color: #e65c00; }
        .label-foto { text-align: left; display: block; margin-top: 15px; font-weight: bold; color: #555; font-size: 14px; }
        #status { margin-top: 15px; font-weight: bold; color: #007bff; }
        .seccion-oculta { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://logistics-josefina.web.app/logo.png" alt="Logo">
        </div>
        <h2>Control de Logística</h2>
        
        <div id="pantalla-clave">
            <input type="password" id="clave" placeholder="Ingrese N° de Camión (Clave)">
            <button onclick="verificarClave()">INGRESAR AL SISTEMA</button>
        </div>

        <div id="formulario" class="seccion-oculta">
            <input type="text" id="transporte" placeholder="Nombre del Transporte">
            <input type="text" id="chofer" placeholder="Nombre del Chofer">
            <input type="text" id="cuit" placeholder="Número de CUIT">
            
            <select id="estado">
                <option value="" disabled selected>Seleccione Estado</option>
                <option value="VACÍO">VACÍO</option>
                <option value="CARGADO">CARGADO</option>
            </select>
            
            <input type="text" id="destino" placeholder="Destino / Cliente">
            
            <label class="label-foto">Foto de Descarga / Remito:</label>
            <input type="file" id="foto" accept="image/*" capture="camera">
            
            <button onclick="enviarReporte()">ENVIAR REPORTE FINAL</button>
        </div>
        
        <p id="status"></p>
    </div>

    <script>
        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC...", 
            authDomain: "control-logistica-2026.firebaseapp.com",
            projectId: "control-logistica-2026",
            appId: "1:389274295324:web:04467597157833633e467d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Función para verificar clave y autocompletar
        function verificarClave() {
            const clave = document.getElementById('clave').value;
            if(clave.trim() !== "") {
                const anterior = localStorage.getItem('datos_camion_' + clave);
                if(anterior) {
                    const data = JSON.parse(anterior);
                    document.getElementById('transporte').value = data.transporte || '';
                    document.getElementById('chofer').value = data.chofer || '';
                    document.getElementById('cuit').value = data.cuit || '';
                }
                document.getElementById('pantalla-clave').classList.add('seccion-oculta');
                document.getElementById('formulario').classList.remove('seccion-oculta');
            } else {
                alert("Por favor, escriba el número de camión.");
            }
        }

        // Función para enviar reporte usando ImgBB
        async function enviarReporte() {
            const status = document.getElementById('status');
            const fileInput = document.getElementById('foto');
            const clave = document.getElementById('clave').value;

            if (fileInput.files.length === 0) {
                alert("Debe sacar una foto para continuar.");
                return;
            }

            status.innerText = "Subiendo imagen... por favor espere";
            let urlImagen = "";

            // Subida a ImgBB
            const formData = new FormData();
            formData.append("image", fileInput.files[0]);

            try {
                const respuesta = await fetch("https://api.imgbb.com/1/upload?key=9caa1af89f65dc79bbae40616bdd0b78", {
                    method: "POST",
                    body: formData
                });
                const resultado = await respuesta.json();
                urlImagen = resultado.data.url;
            } catch (error) {
                alert("Error de conexión al subir la foto.");
                status.innerText = "";
                return;
            }

            status.innerText = "Registrando reporte...";
            const datosParaGuardar = {
                camion: clave,
                transporte: document.getElementById('transporte').value,
                chofer: document.getElementById('chofer').value,
                cuit: document.getElementById('cuit').value,
                estado: document.getElementById('estado').value,
                destino: document.getElementById('destino').value,
                foto: urlImagen,
                fecha: new Date().toLocaleString()
            };

            // Guardar localmente para la próxima vez
            localStorage.setItem('datos_camion_' + clave, JSON.stringify(datosParaGuardar));

            // Guardar en Firebase
            db.collection("reportes").add(datosParaGuardar).then(() => {
                status.innerText = "¡ENVIADO CORRECTAMENTE!";
                status.style.color = "green";
                setTimeout(() => location.reload(), 3000);
            }).catch(() => {
                status.innerText = "Error al conectar con Google.";
            });
        }
    </script>
</body>
</html>

