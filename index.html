<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Transporte La Josefina - Choferes</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #ff6600; 
            margin: 0; 
            padding: 10px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
        }

        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 400px; 
            box-sizing: border-box;
        }

        h2 { 
            color: #ff6600; 
            text-align: center; 
            font-size: 22px; 
            margin: 0 0 15px 0; 
            text-transform: uppercase;
        }

        label { 
            font-size: 12px; 
            font-weight: bold; 
            color: #555; 
            display: block; 
            margin-bottom: 3px; 
            text-transform: uppercase; 
        }

        input, select { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 12px; 
            border-radius: 10px; 
            border: 2px solid #eee; 
            box-sizing: border-box; 
            font-size: 15px; 
            font-weight: 600;
        }

        .tipo-equipo { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-tipo { 
            flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; 
            background: #f0f0f0; font-weight: 800; font-size: 13px; cursor: pointer; 
        }
        .btn-tipo.active { background: #333; color: white; border-color: #000; }

        #aviso-foto { 
            display: none; background: #ff0000; color: white; padding: 12px; 
            border-radius: 15px; margin-bottom: 15px; font-weight: 900; 
            text-align: center; border: 3px solid yellow; font-size: 14px;
            animation: latido 0.8s infinite;
        }

        @keyframes latido {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .btn-enviar { 
            background: #ff6600; color: white; font-weight: 900; border: none; 
            width: 100%; padding: 15px; border-radius: 15px; font-size: 18px; 
            cursor: pointer; text-transform: uppercase; margin-top: 10px;
        }

        #camara-btn { 
            background: #fdfdfd; color: #333; padding: 20px; border-radius: 15px; 
            text-align: center; margin: 10px 0; cursor: pointer; 
            border: 3px dashed #bbb; font-weight: 800; font-size: 15px;
        }

        .preview img { 
            width: 80px; height: 80px; object-fit: cover; border-radius: 10px; 
            border: 3px solid #ff6600; margin-right: 5px;
        }

        .loader { display: none; text-align: center; color: #ff6600; font-weight: 900; padding: 10px; }
    </style>
</head>
<body>

    <div id="login-chof" style="width: 100%; max-width: 350px; margin-top: 50px;">
        <div class="card">
            <h2>LA JOSEFINA</h2>
            <form onsubmit="event.preventDefault(); login();">
                <label>Usuario</label>
                <input type="text" id="nombre-login" required>
                <label>PIN</label>
                <input type="password" id="pin-login" required>
                <button type="submit" class="btn-enviar">ENTRAR</button>
            </form>
        </div>
    </div>

    <div id="form-chof" style="display: none; width: 100%; max-width: 400px;">
        <div class="card">
            <div id="aviso-foto">‚ö†Ô∏è FOTO RECHAZADA<br>POR FAVOR SAC√Å OTRA FOTO DEL TICKET</div>

            <h2>NUEVO REPORTE</h2>
            
            <label>Nombre y Apellido del Chofer</label>
            <input type="text" id="chofer_nombre" placeholder="Nombre completo" oninput="guardarMemoriaLocal()">

            <label>CUIL del Chofer</label>
            <input type="text" id="chofer_cuil" placeholder="00-00000000-0" oninput="guardarMemoriaLocal()">

            <label>Transporte / Empresa</label>
            <input type="text" id="transporte" oninput="guardarMemoriaLocal()">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Chasis</label>
                    <input type="text" id="chasis" oninput="guardarMemoriaLocal()">
                </div>
                <div style="flex: 1;">
                    <label>Acoplado</label>
                    <input type="text" id="acoplado" oninput="guardarMemoriaLocal()">
                </div>
            </div>

            <label>Tipo de Equipo</label>
            <div class="tipo-equipo">
                <button type="button" class="btn-tipo active" id="btn-comun" onclick="setTipoEquipo('Com√∫n')">COM√öN</button>
                <button type="button" class="btn-tipo" id="btn-escalable" onclick="setTipoEquipo('Escalable')">ESCALABLE</button>
            </div>

            <label>Estado</label>
            <select id="estado">
                <option value="VAC√çO">ESTOY VAC√çO</option>
                <option value="CARGADO">ESTOY CARGADO</option>
            </select>
            
            <div id="camara-btn" onclick="document.getElementById('fotos-input').click()">
                üì∏ SACAR FOTO DEL TICKET
                <input type="file" id="fotos-input" multiple accept="image/*" capture="camera" style="display: none;" onchange="procesarFotos()">
            </div>

            <div id="previs-fotos" class="preview" style="display: flex; overflow-x: auto;"></div>

            <div id="cargando-aviso" class="loader">ENVIANDO...</div>
            <button class="btn-enviar" id="btn-enviar-final" onclick="enviar()">ENVIAR REPORTE</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC...", authDomain: "control-logistica-2026.firebaseapp.com", projectId: "control-logistica-2026", appId: "1:389274295324:web:04467597157833633e467d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let fotosBase64 = [];
        let tipoEquipoGlobal = "Com√∫n";
        let choferID = "";

        async function login() {
            const user = document.getElementById('nombre-login').value.toLowerCase();
            const pin = document.getElementById('pin-login').value;
            const snap = await db.collection("accesos_choferes").get();
            snap.forEach(doc => {
                if(doc.id.toLowerCase() === user && doc.data().clave === pin) {
                    choferID = doc.id;
                    document.getElementById('login-chof').style.display = 'none';
                    document.getElementById('form-chof').style.display = 'block';
                    cargarMemoriaLocal();
                    activarRadar();
                }
            });
        }

        function activarRadar() {
            db.collection("reportes").where("chofer", "==", choferID).onSnapshot(s => {
                let rechazo = false;
                s.forEach(doc => { if(doc.data().estado === 'CARGADO' && (!doc.data().fotos || doc.data().fotos.length === 0)) rechazo = true; });
                document.getElementById('aviso-foto').style.display = rechazo ? 'block' : 'none';
            });
        }

        function procesarFotos() {
            const files = document.getElementById('fotos-input').files;
            // AL SACAR FOTO, SE BORRA EL CARTEL ROJO AUTOM√ÅTICAMENTE
            document.getElementById('aviso-foto').style.display = 'none';
            
            Array.from(files).forEach(f => {
                const r = new FileReader();
                r.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 800; canvas.height = (img.height * 800) / img.width;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const b64 = canvas.toDataURL('image/jpeg', 0.7);
                        fotosBase64.push(b64);
                        const nImg = document.createElement('img'); nImg.src = b64;
                        document.getElementById('previs-fotos').appendChild(nImg);
                    }
                };
                r.readAsDataURL(f);
            });
        }

        function setTipoEquipo(t) {
            tipoEquipoGlobal = t;
            document.getElementById('btn-comun').className = t === 'Com√∫n' ? 'btn-tipo active' : 'btn-tipo';
            document.getElementById('btn-escalable').className = t === 'Escalable' ? 'btn-tipo active' : 'btn-tipo';
            guardarMemoriaLocal();
        }

        function guardarMemoriaLocal() {
            const d = {
                n: document.getElementById('chofer_nombre').value,
                cl: document.getElementById('chofer_cuil').value,
                t: document.getElementById('transporte').value,
                ch: document.getElementById('chasis').value,
                ac: document.getElementById('acoplado').value,
                e: tipoEquipoGlobal
            };
            localStorage.setItem('josefina_memo', JSON.stringify(d));
        }

        function cargarMemoriaLocal() {
            const m = JSON.parse(localStorage.getItem('josefina_memo'));
            if(m) {
                document.getElementById('chofer_nombre').value = m.n || "";
                document.getElementById('chofer_cuil').value = m.cl || "";
                document.getElementById('transporte').value = m.t || "";
                document.getElementById('chasis').value = m.ch || "";
                document.getElementById('acoplado').value = m.ac || "";
                if(m.e) setTipoEquipo(m.e);
            }
        }

        async function enviar() {
            if(document.getElementById('estado').value === 'CARGADO' && fotosBase64.length === 0) {
                alert("Falta la foto del ticket"); return;
            }
            document.getElementById('btn-enviar-final').style.display = 'none';
            document.getElementById('cargando-aviso').style.display = 'block';
            
            await db.collection("reportes").add({
                chofer: choferID,
                chofer_nombre: document.getElementById('chofer_nombre').value,
                chofer_cuil: document.getElementById('chofer_cuil').value,
                transporte: document.getElementById('transporte').value,
                chasis: document.getElementById('chasis').value,
                acoplado: document.getElementById('acoplado').value,
                equipo: tipoEquipoGlobal,
                estado: document.getElementById('estado').value,
                fecha: new Date().toLocaleString('es-AR'),
                fotos: fotosBase64
            });
            
            fotosBase64 = [];
            document.getElementById('previs-fotos').innerHTML = "";
            document.getElementById('btn-enviar-final').style.display = 'block';
            document.getElementById('cargando-aviso').style.display = 'none';
            alert("‚úÖ REPORTE ENVIADO");
        }
    </script>
</body>
</html>









































